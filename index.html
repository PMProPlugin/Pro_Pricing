<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin • ProPricing</title>

<link rel="icon" type="image/png" href="ProPlugin LOGO.png">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: {
          sans: ['Prompt', 'system-ui', 'sans-serif']
        },
        colors: {
          brand: {
            red: '#E11D2E'
          }
        }
      }
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<!-- Date range -->
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>

<style>
  :root { color-scheme: dark; }

  body {
    background: radial-gradient(circle at top, #27272a 0, #09090b 55%);
    min-height: 100vh;
  }

  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #18181b; }
  ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 999px; }
  ::-webkit-scrollbar-thumb:hover { background: #52525b; }

  .glass-panel {
    background: radial-gradient(circle at top left, rgba(250,250,250,.06), rgba(24,24,27,.96));
    border: 1px solid rgba(63,63,70,.9);
    box-shadow:
      0 18px 45px rgba(0,0,0,.7),
      0 0 0 1px rgba(148,163,184,.2) inset;
  }

  .tag-pill {
    border-radius: 999px;
    border: 1px solid rgba(63,63,70,.9);
    background: radial-gradient(circle at top left, rgba(39,39,42,.95), rgba(9,9,11,1));
    box-shadow: 0 10px 30px rgba(0,0,0,.8);
  }

  .btn-soft {
    background: radial-gradient(circle at top left, rgba(39,39,42,1), rgba(9,9,11,1));
    border: 1px solid rgba(63,63,70,.95);
    box-shadow: 0 14px 35px rgba(0,0,0,.8);
  }
  .btn-soft:hover {
    border-color: rgba(113,113,122,1);
    background: radial-gradient(circle at top left, rgba(39,39,42,1), rgba(15,23,42,1));
  }

  .btn-primary {
    background: radial-gradient(circle at top left, #ef4444, #b91c1c);
    border: 1px solid #f97373;
    box-shadow:
      0 14px 35px rgba(248,113,113,.55),
      0 0 0 1px rgba(30,64,175,.4) inset;
  }
  .btn-primary:hover {
    filter: brightness(1.05);
    box-shadow:
      0 18px 40px rgba(248,113,113,.7),
      0 0 0 1px rgba(30,64,175,.6) inset;
  }

  .badge {
    border-radius: 999px;
    background: linear-gradient(135deg, rgba(39,39,42,1), rgba(9,9,11,1));
    border: 1px solid rgba(82,82,91,1);
    box-shadow: 0 10px 30px rgba(0,0,0,.85);
  }

  .settings-panel {
    backdrop-filter: blur(18px);
    background: radial-gradient(circle at top left, rgba(24,24,27,.98), rgba(0,0,0,.98));
    border-left: 1px solid rgba(63,63,70,1);
    box-shadow: -20px 0 60px rgba(0,0,0,.95);
  }

  .tab-pill {
    border-radius: 999px;
    border: 1px solid transparent;
  }
  .tab-pill-active {
    background: radial-gradient(circle at top left, rgba(39,39,42,1), rgba(9,9,11,1));
    border-color: rgba(82,82,91,1);
    box-shadow:
      0 12px 30px rgba(0,0,0,.85),
      0 0 0 1px rgba(148,163,184,.3) inset;
  }

  table { border-collapse:collapse; }
  table th, table td { border:1px solid #3f3f46; }
  #productTHead { z-index:20; }
  #productBody { position:relative; z-index:1; }

  #printModal {
    background: rgba(9,9,11,.9);
    backdrop-filter: blur(22px);
  }

  .print-preview-page {
    width: 297mm;
    height: 210mm;
    background: white;
    color: black;
  }

  .tooltip {
    position: relative;
  }
  .tooltip span[data-tooltip] {
    position:absolute;
    bottom:120%;
    left:50%;
    transform:translateX(-50%);
    background:#27272a;
    color:#e4e4e7;
    font-size:11px;
    padding:4px 8px;
    border-radius:6px;
    white-space:nowrap;
    opacity:0;
    pointer-events:none;
    transition:opacity .15s ease, transform .15s ease;
    border:1px solid #3f3f46;
    box-shadow:0 10px 30px rgba(0,0,0,.8);
  }
  .tooltip:hover span[data-tooltip] {
    opacity:1;
    transform:translateX(-50%) translateY(-2px);
  }

  .filter-dropdown {
    position:fixed;
    z-index:60;
    min-width:220px;
    display:none;
  }
  .filter-dropdown.show {
    display:block;
  }
  .filter-dropdown-content {
    background:#18181b;
    border-radius:14px;
    border:1px solid #3f3f46;
    box-shadow:0 18px 45px rgba(0,0,0,.9);
    padding:10px;
  }

  .style-btn { border-radius:999px; border:1px solid #3f3f46; padding:3px 10px; font-size:11px; }
  .style-btn.active { background:#E11D2E; border-color:#ff5566; }

  #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
  .toast { padding:12px 20px; border-radius:8px; color:white; font-size:14px; border:1px solid #555; animation:toast-in .3s ease, toast-out .3s ease 2.7s; }
  .toast.info { background:#18181b; }
  .toast.success { background:#166534; border-color:#22c55e; }
  .toast.error { background:#991b1b; border-color:#ef4444; }
  @keyframes toast-in { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
  @keyframes toast-out { from { transform:translateX(0); opacity:1; } to { transform:translateX(100%); opacity:0; } }

  .confirm-overlay { position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index:9990; display:grid; place-items:center; }
  .confirm-modal { background:#18181b; border:1px solid #555; border-radius:18px; padding:20px 22px; width:100%; max-width:400px; box-shadow:0 8px 24px rgba(0,0,0,.6); }

  /* Template editor preview */
  .tpl-stage { position:relative; width:420px; height:594px; border:1px solid #444; background:#0b0b0c; overflow:hidden; border-radius:12px; }
  .tpl-node { position:absolute; cursor:move; user-select:none; }
  .tpl-node.dragging { outline:2px dashed #E11D2E; }
</style>
</head>

<body class="text-white font-sans">

<!-- =================== SETUP (First time) =================== -->
<section id="setupView" class="hidden min-h-screen grid place-items-center">
  <div
    class="glass-panel px-10 py-8 rounded-3xl max-w-xl w-full mx-4 relative overflow-hidden">
    <div class="absolute -top-24 -right-24 w-64 h-64 rounded-full bg-brand.red/20 blur-3xl pointer-events-none"></div>

    <div class="flex items-center gap-3 mb-6 relative">
      <div class="w-12 h-12 rounded-2xl bg-black/80 border border-zinc-700 grid place-items-center">
        <span class="material-icons text-brand.red text-3xl">precision_manufacturing</span>
      </div>
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">System Setup</h1>
        <p class="text-sm text-zinc-400">
          Create your Host account to start using ProPricing Online.
        </p>
      </div>
    </div>

    <div class="space-y-4 relative">
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">Username (Host)</label>
        <input id="setupUser" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm" placeholder="e.g. proplugin-host">
      </div>
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">Email</label>
        <input id="setupEmail" type="email" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm" placeholder="you@example.com">
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-zinc-400 mb-1">Password</label>
          <input id="setupPass" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm">
        </div>
        <div>
          <label class="block text-xs font-medium text-zinc-400 mb-1">Confirm Password</label>
          <input id="setupPassConfirm" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm">
        </div>
      </div>
    </div>

    <div class="mt-6 flex items-center justify-between gap-3">
      <p class="text-xs text-zinc-500 max-w-xs">
        This Host account will manage all users, templates, and price data for your organization.
      </p>
      <button id="btnSetup"
        class="btn-primary px-5 py-2.5 rounded-2xl text-sm font-semibold flex items-center gap-2">
        <span class="material-icons text-sm">bolt</span>
        <span>Create Host</span>
      </button>
    </div>
  </div>
</section>

<!-- =================== LOGIN =================== -->
<section id="loginView" class="hidden min-h-screen grid place-items-center">
  <div class="glass-panel px-10 py-8 rounded-3xl max-w-md w-full mx-4 relative overflow-hidden">
    <div class="absolute -top-24 -left-24 w-64 h-64 rounded-full bg-brand.red/20 blur-3xl pointer-events-none"></div>

    <div class="flex items-center gap-3 mb-6 relative">
      <div class="w-12 h-12 rounded-2xl bg-black/80 border border-zinc-700 grid place-items-center">
        <span class="material-icons text-brand.red text-3xl">price_change</span>
      </div>
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">ProPricing Online</h1>
        <p class="text-sm text-zinc-400">
          Login with your ProPricing account.
        </p>
      </div>
    </div>

    <div class="space-y-4 relative">
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">Username or Email</label>
        <input id="loginUser" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm" placeholder="your-username">
      </div>
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">Password</label>
        <input id="loginPass" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm">
      </div>
    </div>

    <div class="mt-6 flex items-center justify-between gap-3">
      <div class="text-xs text-zinc-500 flex-1">
        <div id="loginError" class="text-red-400 mb-1 hidden"></div>
        <div id="loginLoading" class="text-zinc-400 hidden">Connecting to server…</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnGotoForgot"
          class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs font-medium">
          Forgot Password?
        </button>
        <button id="btnLogin"
          class="btn-primary px-5 py-2.5 rounded-2xl text-sm font-semibold flex items-center gap-2">
          <span class="material-icons text-sm">login</span>
          <span>Sign in</span>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- =================== RESET PASSWORD =================== -->
<section id="resetView" class="hidden min-h-screen grid place-items-center">
  <div class="glass-panel px-10 py-8 rounded-3xl max-w-md w-full mx-4 relative overflow-hidden">
    <div class="absolute -top-24 -right-24 w-64 h-64 rounded-full bg-brand.red/20 blur-3xl pointer-events-none"></div>

    <div class="flex items-center gap-3 mb-6 relative">
      <div class="w-12 h-12 rounded-2xl bg-black/80 border border-zinc-700 grid place-items-center">
        <span class="material-icons text-brand.red text-3xl">lock_reset</span>
      </div>
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Reset Password</h1>
        <p class="text-sm text-zinc-400" id="resetSubtitle">
          Enter your email to receive a one-time code.
        </p>
      </div>
    </div>

    <div id="resetStep1" class="space-y-4">
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">Email</label>
        <input id="resetEmail" type="email" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm" placeholder="you@example.com">
      </div>
      <div class="flex items-center justify-between mt-4">
        <button id="btnBackToLogin1"
          class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs font-medium">
          Back
        </button>
        <button id="btnRequestOtp"
          class="btn-primary px-5 py-2.5 rounded-2xl text-sm font-semibold flex items-center gap-2">
          <span class="material-icons text-sm">email</span>
          <span>Send OTP</span>
        </button>
      </div>
    </div>

    <div id="resetStep2" class="space-y-4 hidden">
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">OTP Code</label>
        <input id="resetOtp" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm" placeholder="4-digit code">
      </div>
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">New Password</label>
        <input id="resetNewPass" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-1 focus:ring-brand.red text-sm">
      </div>
      <div class="flex items-center justify-between mt-4">
        <button id="btnBackToLogin2"
          class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs font-medium">
          Back to Login
        </button>
        <button id="btnConfirmReset"
          class="btn-primary px-5 py-2.5 rounded-2xl text-sm font-semibold flex items-center gap-2">
          <span class="material-icons text-sm">done_all</span>
          <span>Change Password</span>
        </button>
      </div>
    </div>

    <div id="resetMsg" class="mt-4 text-xs text-zinc-400"></div>
  </div>
</section>

<!-- =================== MAIN APP =================== -->
<section id="appView" class="hidden min-h-screen">
  <header class="sticky top-0 z-40 border-b border-zinc-800 bg-gradient-to-b from-black/90 via-black/80 to-black/40 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 lg:px-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-black/90 border border-zinc-700 grid place-items-center overflow-hidden">
            <img id="mainLogo" src="ProPlugin LOGO.png" alt="ProPlugin" class="w-8 h-8 object-contain">
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h1 class="text-lg sm:text-xl font-semibold tracking-tight">ProPricing</h1>
              <span class="px-2 py-0.5 text-[11px] rounded-full bg-emerald-500/10 border border-emerald-500/40 text-emerald-300 font-medium">
                Online
              </span>
            </div>
            <p class="text-[11px] text-zinc-500">
              Master price reference for every channel.
            </p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="badge px-3 py-1.5 text-xs flex items-center gap-2">
            <span id="roleBadge" class="uppercase tracking-wide text-[10px] text-zinc-300">ROLE • USER</span>
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_0_4px_rgba(34,197,94,.25)]"></span>
          </div>
          <button id="btnSettings"
            class="btn-soft px-3 py-2 rounded-2xl text-xs font-medium flex items-center gap-2">
            <span class="material-icons text-sm">tune</span>
            <span>Settings</span>
          </button>
          <button id="btnLogout"
            class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs font-medium flex items-center gap-1.5">
            <span class="material-icons text-sm">logout</span>
            <span>Sign out</span>
          </button>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-2 flex-1 min-w-[260px]">
          <div class="flex-1 relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="material-icons text-zinc-500 text-base">search</span>
            </div>
            <input id="searchInput"
              class="w-full pl-10 pr-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-sm focus:outline-none focus:ring-1 focus:ring-brand.red"
              placeholder="Search by SKU or description">
          </div>
          </div>

        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Channel</span>
            <select id="channelSelect"
              class="px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-sm focus:outline-none focus:ring-1 focus:ring-brand.red min-w-[130px]">
              <option>Flagship</option>
              <option>Marketplace</option>
              <option>Dealer</option>
            </select>
          </div>

          <div class="px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 flex items-center gap-2">
            <span class="text-sm text-zinc-400 whitespace-nowrap">Select Expire Date</span>
            <input id="dateRangePicker"
              class="px-3 py-2 rounded-xl bg-black border border-zinc-700 w-64 text-center text-xs sm:text-sm"
              placeholder="Pick range">
            <button id="btnDateClear"
              class="px-2.5 py-1.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-[11px]">
              Clear
            </button>
            <input id="dateStart" type="hidden">
            <input id="dateEnd" type="hidden">
          </div>

          <button id="btnNewProduct"
            class="btn-primary px-3.5 py-2 rounded-2xl text-xs font-semibold flex items-center gap-2">
            <span class="material-icons text-sm">add_circle</span>
            <span>Add Item</span>
          </button>

          <button id="btnPrintModal"
            class="px-3.5 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs font-semibold flex items-center gap-2">
            <span class="material-icons text-sm">print</span>
            <span>Print</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-4 lg:px-6 lg:py-6">
    <div class="overflow-auto border border-zinc-800 rounded-2xl">
      <table class="w-full text-sm">
        <thead id="productTHead" class="bg-zinc-900/70 border-b-2 border-zinc-700 sticky top-0"></thead>
        <tbody id="productBody" class="[&>tr:nth-child(odd)]:bg-zinc-800/60"></tbody>
      </table>
    </div>
    <div class="mt-4 flex items-center justify-between">
      <div></div>
      <div id="pagination" class="flex justify-center items-center gap-1"></div>
      <button id="btnExportChannel"
              class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm font-semibold">
        Export
      </button>
    </div>
  </main>
</section>

<!-- =================== SETTINGS PANEL =================== -->
<div id="settingsPanel" class="hidden fixed inset-0 w-full max-w-none settings-panel z-50">
  <div class="h-full flex flex-col">
    <div class="px-5 pt-4 pb-3 border-b border-zinc-800 flex items-center justify-between gap-3">
      <div>
        <h2 class="text-sm font-semibold tracking-tight flex items-center gap-2">
          <span class="material-icons text-base text-brand.red">tune</span>
          <span>Settings</span>
        </h2>
        <p class="text-[11px] text-zinc-500">Manage templates, pricing, and user access.</p>
      </div>
      <button id="btnCloseSettings"
        class="w-8 h-8 rounded-full border border-zinc-700 bg-black/60 hover:bg-zinc-900 grid place-items-center">
        <span class="material-icons text-zinc-400 text-base">close</span>
      </button>
    </div>

    <div class="px-4 pt-3 pb-2 border-b border-zinc-800">
      <div class="flex flex-wrap gap-2 text-[11px]">
        <button class="set-tab tab-pill tab-pill-active px-3 py-1 flex items-center gap-1 border-zinc-700"
          data-tab="data">
          <span class="material-icons text-xs">table_view</span>
          <span>Data</span>
        </button>
        <button class="set-tab tab-pill px-3 py-1 flex items-center gap-1"
          data-tab="promo">
          <span class="material-icons text-xs">sell</span>
          <span>Promotion</span>
        </button>
        <button class="set-tab tab-pill px-3 py-1 flex items-center gap-1"
          data-tab="templates">
          <span class="material-icons text-xs">view_quilt</span>
          <span>Template Management</span>
        </button>
        <button class="set-tab tab-pill px-3 py-1 flex items-center gap-1"
          data-tab="logo">
          <span class="material-icons text-xs">branding_watermark</span>
          <span>Manage Logo</span>
        </button>
        <button class="set-tab tab-pill px-3 py-1 flex items-center gap-1"
          data-tab="dealer">
          <span class="material-icons text-xs">storefront</span>
          <span>Dealer</span>
        </button>
        <button class="set-tab tab-pill px-3 py-1 flex items-center gap-1"
          data-tab="users">
          <span class="material-icons text-xs">group</span>
          <span>User Management</span>
        </button>
        <button class="set-tab tab-pill px-3 py-1 flex items-center gap-1"
          data-tab="history">
          <span class="material-icons text-xs">history</span>
          <span>History</span>
        </button>
      </div>
    </div>

    <div id="settingsContent" class="flex-1 overflow-y-auto px-4 pb-4 pt-3 text-xs text-zinc-300">
    </div>
  </div>
</div>

<!-- =================== EDITOR MODAL =================== -->
<div id="editorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur">
  <div class="glass-panel max-w-2xl w-full mx-4 rounded-3xl p-6 relative">
    <div class="flex items-center justify-between gap-3 mb-4">
      <div>
        <h2 id="editorTitle" class="text-lg font-semibold tracking-tight">Add New Product</h2>
        <p class="text-xs text-zinc-500">Fill in the details for this SKU and channel pricing.</p>
      </div>
      <button id="btnCloseEditor"
        class="w-8 h-8 rounded-full border border-zinc-700 bg-black/60 hover:bg-zinc-900 grid place-items-center">
        <span class="material-icons text-zinc-400 text-base">close</span>
      </button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">SKU</label>
        <input id="edSku" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">Brand</label>
        <input id="edBrand" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div class="sm:col-span-2">
        <label class="block text-[11px] text-zinc-400 mb-1">Description</label>
        <input id="edDesc" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div class="sm:col-span-2">
        <label class="block text-[11px] text-zinc-400 mb-1">Details (optional)</label>
        <textarea id="edDetails" rows="2" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red"></textarea>
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">Category</label>
        <input id="edCategory" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">Expire Date (Promotion)</label>
        <input id="edExpire" type="date" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">Normal Price</label>
        <input id="edNormal" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">Promotion Price</label>
        <input id="edPromo" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1">Marketplace Price</label>
        <input id="edMarket" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1"><span id="lblEdT1">Dealer T1</span></label>
        <input id="edT1" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1"><span id="lblEdT2">Dealer T2</span></label>
        <input id="edT2" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
      <div>
        <label class="block text-[11px] text-zinc-400 mb-1"><span id="lblEdT3">Dealer T3</span></label>
        <input id="edT3" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
      </div>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <p class="text-[11px] text-zinc-500 max-w-xs">
        Changes will be synced to GitHub when you save.
      </p>
      <button id="btnSaveEd"
        class="btn-primary px-4 py-2 rounded-2xl text-xs font-semibold flex items-center gap-2">
        <span class="material-icons text-sm">save</span>
        <span>Save</span>
      </button>
    </div>
  </div>
</div>

<!-- =================== PRINT MODAL =================== -->
<div id="printModal" class="hidden fixed inset-0 z-40 flex items-center justify-center">
  <div class="max-w-6xl w-full mx-4 bg-zinc-950/95 border border-zinc-800 rounded-3xl shadow-2xl flex flex-col max-h-[90vh]">
    <div class="px-5 py-3 border-b border-zinc-800 flex items-center justify-between gap-3">
      <div>
        <h2 class="text-sm font-semibold tracking-tight flex items-center gap-2">
          <span class="material-icons text-base text-brand.red">print</span>
          <span>Print Tags</span>
        </h2>
        <p class="text-[11px] text-zinc-500">
          Select SKUs and template, then open in a separate tab for printing.
        </p>
      </div>
      <button id="btnClosePrintModal"
        class="w-8 h-8 rounded-full border border-zinc-700 bg-black/60 hover:bg-zinc-900 grid place-items-center">
        <span class="material-icons text-zinc-400 text-base">close</span>
      </button>
    </div>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
      <div class="md:w-1/2 border-r border-zinc-800 flex flex-col">
        <div class="p-4 border-b border-zinc-800 flex items-center gap-2">
          <input id="printSearch"
            class="flex-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red"
            placeholder="Search SKU or description for printing">
          <button id="btnPrintImport"
            class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px] flex items-center gap-1.5">
            <span class="material-icons text-xs">upload</span>
            <span>Import</span>
          </button>
        </div>
        <div class="flex-1 overflow-auto">
          <table class="w-full text-xs">
            <thead class="bg-zinc-900/80 border-b border-zinc-700 sticky top-0">
              <tr>
                <th class="px-3 py-2 w-14"><label class="inline-flex items-center gap-1"><input id="printCheckAll" type="checkbox"> <span>Select</span></label></th>
                <th class="px-3 py-2 w-20">SKU</th>
                <th class="px-3 py-2">Description</th>
                <th class="px-2 py-2 w-16">Qty</th>
              </tr>
            </thead>
            <tbody id="printBody"></tbody>
          </table>
        </div>
      </div>

      <div class="md:w-1/2 flex flex-col">
        <div class="p-4 border-b border-zinc-800 flex items-center gap-3">
          <div class="flex-1">
            <label class="block text-[11px] text-zinc-400 mb-1">Template</label>
            <select id="printTemplate"
              class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
            </select>
          </div>
          <button id="btnOpenPrint"
            class="btn-primary px-4 py-2 rounded-2xl text-xs font-semibold flex items-center gap-2">
            <span class="material-icons text-sm">open_in_new</span>
            <span>Open Print Tab</span>
          </button>
        </div>

        <div class="flex-1 overflow-auto bg-zinc-950">
          <div class="p-4">
            <div class="text-[11px] text-zinc-500 flex items-center justify-between mb-2">
              <span>Live Preview</span>
              <span class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                <span>Linked to current template</span>
              </span>
            </div>
            <div id="previewBox" class="bg-zinc-900 border border-zinc-800 rounded-2xl overflow-auto max-h-[440px]"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm container -->
<div id="confirm-container"></div>

<!-- Toasts -->
<div id="toast-container"></div>

<script>
const LS = {
  LAST_USER: 'propricing:lastUser'
};

let appData = null;
let currentUser = null;
let editingIndex = -1;
let currentTemplateId = null;
let currentPage = 1;
let rowsPerPage = 50;
let columnFilters = {};
let sortState = { key: 'sku', direction: 'asc' };

function $(sel){ return document.querySelector(sel); }
function $$(sel){ return Array.from(document.querySelectorAll(sel)); }

function showToast(message, type='info') {
  const container = $('#toast-container');
  const div = document.createElement('div');
  div.className = `toast ${type}`;
  div.textContent = message;
  container.appendChild(div);
  setTimeout(()=>{ div.remove(); }, 3000);
}

function showConfirm(title, message) {
  return new Promise(resolve => {
    const container = $('#confirm-container');
    container.innerHTML = `
      <div class="confirm-overlay">
        <div class="confirm-modal">
          <h3 class="text-xl font-bold mb-2">${title}</h3>
          <p class="text-zinc-400 mb-6">${message}</p>
          <div class="flex justify-end gap-3">
            <button id="confirm-cancel" class="px-4 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Cancel</button>
            <button id="confirm-ok" class="px-4 py-2 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Confirm</button>
          </div>
        </div>
      </div>`;

    const overlay = container.querySelector('.confirm-overlay');
    const btnOk = $('#confirm-ok');
    const btnCancel = $('#confirm-cancel');

    const cleanup = (result) => {
      container.innerHTML = '';
      window.removeEventListener('keydown', handleKey);
      resolve(result);
    };

    const handleKey = (e) => {
      const tag = (document.activeElement?.tagName || '').toLowerCase();
      const isTextarea = tag === 'textarea';

      if (e.key === 'Escape') {
        e.preventDefault();
        cleanup(false);
      } else if (e.key === 'Enter' && !isTextarea) {
        e.preventDefault();
        cleanup(true);
      }
    };

    btnOk.onclick = () => cleanup(true);
    btnCancel.onclick = () => cleanup(false);
    overlay.onclick = (e) => {
      if (e.target === overlay) cleanup(false);
    };

    window.addEventListener('keydown', handleKey);
  });
}

function attachModalShortcuts(modalEl, { defaultButton, cancelButton }) {
  if (!modalEl) return;

  const handler = (e) => {
    if (modalEl.classList.contains('hidden')) return;

    const active = document.activeElement;
    const tag = (active?.tagName || '').toLowerCase();
    const type = (active?.getAttribute('type') || '').toLowerCase();

    const isTextarea = tag === 'textarea';
    const isButton = tag === 'button';
    const isSubmitInput = tag === 'input' && (type === 'submit' || type === 'button');

    if (e.key === 'Escape') {
      e.preventDefault();
      cancelButton?.click();
    } else if (e.key === 'Enter' && !isTextarea && !isButton && !isSubmitInput) {
      e.preventDefault();
      defaultButton?.click();
    }
  };

  modalEl.__keyHandler = handler;
  window.addEventListener('keydown', handler);
}

function detachModalShortcuts(modalEl) {
  if (!modalEl || !modalEl.__keyHandler) return;
  window.removeEventListener('keydown', modalEl.__keyHandler);
  delete modalEl.__keyHandler;
}

function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

async function apiLoad(){
  const res = await fetch('/api/data');
  if (!res.ok) throw new Error('Failed to load data');
  const data = await res.json();
  appData = data;
  applyMainLogo();
}

async function apiSave(){
  if (!appData) return;
  const res = await fetch('/api/save', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body:JSON.stringify(appData)
  });
  if (!res.ok) {
    const d = await res.json().catch(()=>({}));
    console.error('Save failed', d);
    showToast(d.error || 'Failed to save data.', 'error');
  }
}

async function apiOtp(action, email, otp=null, newPasswordHash=null){
  const res = await fetch('/api/otp', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body:JSON.stringify({ action, email, otp, newPasswordHash })
  });
  const data = await res.json().catch(()=>({}));
  if (!res.ok) {
    throw new Error(data.error || 'Operation failed');
  }
  return data;
}

async function forceReloadAppData(){
  const res = await fetch('/api/data', { cache:'no-store' });
  if (!res.ok) throw new Error('Failed to reload data');
  appData = await res.json();
  applyMainLogo();
  renderTableHeader();
  renderTable();
}

function updateLocalDataAndSave(newData){
  if (newData) appData = newData;
  if (!appData) return;
  renderTableHeader();
  renderTable();
  applyDealerNamesToUI();
  applyMainLogo();
  apiSave();
}

function hashPassword(pw){
  const encoder = new TextEncoder();
  const data = encoder.encode(pw);
  return crypto.subtle.digest('SHA-256', data).then(buf=>{
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  });
}

function log(action, meta = '') {
  if (!appData) return;
  if (!appData.logs) appData.logs = [];
  appData.logs.unshift({
    ts: new Date().toISOString(),
    user: currentUser?.username || '-',
    action,
    meta
  });
  if (appData.logs.length > 3000) appData.logs.pop();
}

function applyMainLogo(){
  if (!appData || !appData.brandLogoUrls) return;
  const url = appData.logoUrl || 'ProPlugin LOGO.png';
  const img = $('#mainLogo');
  if (img) img.src = url;
}

/* ================= TABLE RENDER ================= */

function renderTableHeader() {
  const thead = $('#productTHead');
  const columns = [
    { key: 'sku', label: 'SKU', width: '120px', sortable: true },
    { key: 'brand', label: 'Brand', width: '120px', sortable: true },
    { key: 'description', label: 'Description', width: '200px', sortable: true },
    { key: 'details', label: 'Details', width: '200px', class: 'hidden', sortable: false },
    { key: 'category', label: 'Category', width: '120px', sortable: true },
    { key: 'normal', label: 'Normal Price', width: '110px', class: 'col-normal', sortable: true },
    { key: 'market', label: 'Marketplace Price', width: '120px', class: 'col-market', sortable: true },
    { key: 'promo', label: 'Promotion', width: '100px', class: 'col-promo', sortable: true },
    { key: 'expire', label: 'Expire Date', width: '110px', class: 'col-expire', sortable: true },
    { key: 'marketmargin', label: 'Margin', width: '80px', class: 'col-marketmargin hidden', sortable: false },
    { key: 't1', label: `<span id="lblT1">Dealer T1</span>`, width: '100px', class: 'col-t1', sortable: true },
    { key: 'margin1', label: 'Margin', width: '80px', class: 'col-margin1', sortable: false },
    { key: 't2', label: `<span id="lblT2">Dealer T2</span>`, width: '100px', class: 'col-t2', sortable: true },
    { key: 'margin2', label: 'Margin', width: '80px', class: 'col-margin2', sortable: false },
    { key: 't3', label: `<span id="lblT3">Dealer T3</span>`, width: '100px', class: 'col-t3', sortable: true },
    { key: 'margin3', label: 'Margin', width: '80px', class: 'col-margin3', sortable: false },
    { key: 'actions', label: 'Actions', width: '100px', class: 'col-actions', sortable: false }
  ];
  const filterableKeys = ['sku','brand','description','category','normal','promo','expire','market','t1','t2','t3'];
  let headerHTML = `<tr class="[&>th]:px-3 [&>th]:py-3 text-left [&>th]:sticky [&>th]:top-0">`;
  columns.forEach(col => {
    let thClass = col.class || ''; let thAttrs = ''; let label = col.label;
    if (col.sortable) {
      thClass += ' cursor-pointer hover:bg-zinc-800 transition-colors';
      thAttrs += ` data-sort-key="${col.key}"`;
      if (sortState.key === col.key) label += sortState.direction === 'asc' ? ' <span class="text-zinc-400">▲</span>' : ' <span class="text-zinc-400">▼</span>';
    }
    let content = (filterableKeys.includes(col.key))
      ? `<div class="flex items-center justify-between w-full"><div>${label}</div><button class="filter-btn ${(columnFilters[col.key] && columnFilters[col.key].size>0)?'active':''}" data-filter-key="${col.key}">▼</button></div><div id="filter-dropdown-${col.key}" class="filter-dropdown"></div>`
      : label;
    headerHTML += `<th style="width:${col.width}" class="${thClass}"${thAttrs}>${content}</th>`;
  });
  headerHTML += `</tr>`;
  thead.innerHTML = headerHTML;

  thead.querySelectorAll('[data-sort-key]').forEach(th=>{
    th.onclick = ()=>{
      const key = th.getAttribute('data-sort-key');
      if (sortState.key === key) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.key = key;
        sortState.direction = 'asc';
      }
      renderTableHeader();
      renderTable();
    };
  });

  thead.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      const key = btn.getAttribute('data-filter-key');
      buildFilterDropdown(key, btn);
    };
  });
}

function buildFilterDropdown(key, anchor){
  const dd = $(`#filter-dropdown-${key}`);

  const filterKeyMap = {
    normal: 'normalPrice',
    promo: 'promoPrice',
    expire: 'expiresDate',
    market: 'marketplacePrice',
    t1: 'dealer1',
    t2: 'dealer2',
    t3: 'dealer3'
  };
  const prop = filterKeyMap[key] || key;

  const values = new Set(
    (appData.products || [])
      .map(p => String(p[prop] ?? ''))
      .filter(v => v !== '')
  );

  dd.innerHTML = `
    <div class="filter-dropdown-content">
      <div class="flex items-center gap-2 mb-1">
        <input type="text" class="w-full px-2 py-1 rounded bg-zinc-900 border border-zinc-700 text-xs" placeholder="Search value..." data-filter-search="${key}" />
      </div>
      <div class="max-h-52 overflow-auto text-xs space-y-1" data-filter-list="${key}">
        ${Array.from(values).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'})).map(v=>{
          const checked = columnFilters[key] && columnFilters[key].has(v);
          return `<label class="flex items-center gap-2">
            <input type="checkbox" value="${v.replace(/"/g,'&quot;')}" ${checked?'checked':''} class="filter-chk" data-filter-key="${key}" />
            <span>${v||'<em>(empty)</em>'}</span>
          </label>`;
        }).join('')}
      </div>
      <div class="flex justify-between mt-2 text-xs">
        <button class="px-2 py-1 rounded bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-filter-clear="${key}">Clear</button>
        <button class="px-2 py-1 rounded bg-brand.red hover:bg-red-600 border border-red-700" data-filter-apply="${key}">Apply</button>
      </div>
    </div>`;

  const rect = anchor.getBoundingClientRect();
  dd.style.left = rect.left + 'px';
  dd.style.top  = (rect.bottom + 4) + 'px';
  dd.classList.add('show');
}

function closeAllFilterDropdowns(){
  $$('.filter-dropdown').forEach(dd=>dd.classList.remove('show'));
}

document.addEventListener('input', (e)=>{
  const searchInput = e.target.closest('input[data-filter-search]');
  if (!searchInput) return;
  const key = searchInput.getAttribute('data-filter-search');
  const list = document.querySelector(`[data-filter-list="${key}"]`);
  if (!list) return;
  const q = searchInput.value.trim().toLowerCase();
  list.querySelectorAll('label').forEach(lbl=>{
    const text = lbl.textContent.toLowerCase();
    lbl.style.display = !q || text.includes(q) ? '' : 'none';
  });
});

document.addEventListener('click', (e)=>{
  const clearBtn = e.target.closest('[data-filter-clear]');
  const applyBtn = e.target.closest('[data-filter-apply]');
  if (clearBtn) {
    const key = clearBtn.getAttribute('data-filter-clear');
    columnFilters[key] = new Set();
    const box = clearBtn.closest('.filter-dropdown');
    if (box) box.classList.remove('show');
    currentPage = 1;
    renderTable();
  } else if (applyBtn) {
    const key = applyBtn.getAttribute('data-filter-apply');
    const box = applyBtn.closest('.filter-dropdown');
    const checks = box.querySelectorAll('.filter-chk');
    const set = new Set();
    checks.forEach(ch=>{ if (ch.checked) set.add(ch.value); });
    columnFilters[key] = set;
    if (box) box.classList.remove('show');
    currentPage = 1;
    renderTable();
  }
});

/* ================= FILTERED DATA ================= */

function filteredProducts(){
  if (!appData) return [];

  const q  = $('#searchInput').value.trim().toLowerCase();
  const ds = $('#dateStart').value;
  const de = $('#dateEnd').value;
  const ch = $('#channelSelect').value;
  const isFlagship = ch === 'Flagship';

  const filterKeyMap = {
    normal: 'normalPrice',
    promo: 'promoPrice',
    expire: 'expiresDate',
    market: 'marketplacePrice',
    t1: 'dealer1',
    t2: 'dealer2',
    t3: 'dealer3'
  };

  const filtered = (appData.products || []).filter(p => {
    const generalSearchHit =
      !q ||
      (p.sku || '').toLowerCase().includes(q) ||
      (p.description || '').toLowerCase().includes(q);

    const columnFilterHit = Object.keys(columnFilters).every(key => {
      const set = columnFilters[key];
      if (!set || set.size === 0) return true;

      const prop = filterKeyMap[key] || key;
      const value = p[prop];

      return set.has(String(value ?? ''));
    });

    let dateOk = true;
    if (isFlagship && (ds || de)) {
      const ex = p.expiresDate ? new Date(p.expiresDate) : null;

      if (!ex) {
        dateOk = false;
      } else {
        if (ds && ex < new Date(ds + 'T00:00:00')) dateOk = false;
        if (de && ex > new Date(de + 'T23:59:59')) dateOk = false;
      }
    }

    let channelOk = true;
    if (!isFlagship) {
      if (ch === 'Dealer') {
        channelOk = !!(p.dealer1 || p.dealer2 || p.dealer3);
      } else if (ch === 'Marketplace') {
        channelOk = !!p.marketplacePrice;
      } else {
        channelOk = true;
      }
    }

    return generalSearchHit && columnFilterHit && dateOk && channelOk;
  });

  const { key: sortKey, direction } = sortState;
  const dataKeyMap = {
    normal: 'normalPrice',
    promo: 'promoPrice',
    expire: 'expiresDate',
    market: 'marketplacePrice',
    t1: 'dealer1',
    t2: 'dealer2',
    t3: 'dealer3'
  };
  const dataKey = dataKeyMap[sortKey] || sortKey;

  filtered.sort((a, b) => {
    const valA = a[dataKey];
    const valB = b[dataKey];

    if (valA == null || valA === '') return 1;
    if (valB == null || valB === '') return -1;

    let comparison = 0;
    if (typeof valA === 'number' && typeof valB === 'number') {
      comparison = valA - valB;
    } else {
      comparison = String(valA).localeCompare(String(valB), undefined, {
        numeric: true,
        sensitivity: 'base'
      });
    }

    return direction === 'asc' ? comparison : -comparison;
  });

  return filtered;
}

function renderTable(){
  if (!appData) return;
  const tbody = $('#productBody');
  const rows = filteredProducts();
  const totalPages = Math.max(1, Math.ceil(rows.length / rowsPerPage));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*rowsPerPage;
  const pageRows = rows.slice(start, start+rowsPerPage);
  const ch = $('#channelSelect').value;
  const isFlagship = ch === 'Flagship';

  let html = '';
  pageRows.forEach(p=>{
    const normal = p.normalPrice || 0;
    const promo = p.promoPrice || 0;
    const market = p.marketplacePrice || 0;
    const t1 = p.dealer1 || 0;
    const t2 = p.dealer2 || 0;
    const t3 = p.dealer3 || 0;
    const expire = p.expiresDate || '';
    const marketMargin = (market && normal) ? ((market - normal)/normal*100) : 0;
    const margin1 = (t1 && normal) ? ((t1 - normal)/normal*100) : 0;
    const margin2 = (t2 && normal) ? ((t2 - normal)/normal*100) : 0;
    const margin3 = (t3 && normal) ? ((t3 - normal)/normal*100) : 0;

    html += `<tr class="hover:bg-zinc-900/80">
      <td class="px-3 py-2 text-xs font-mono">${p.sku || ''}</td>
      <td class="px-3 py-2 text-xs">${p.brand || ''}</td>
      <td class="px-3 py-2 text-xs">${p.description || ''}</td>
      <td class="px-3 py-2 text-xs hidden">${p.details || ''}</td>
      <td class="px-3 py-2 text-xs">${p.category || ''}</td>
      <td class="px-3 py-2 text-xs text-right col-normal">${normal ? normal.toLocaleString() : ''}</td>
      <td class="px-3 py-2 text-xs text-right col-market">${market ? market.toLocaleString() : ''}</td>
      <td class="px-3 py-2 text-xs text-right col-promo">${promo ? promo.toLocaleString() : ''}</td>
      <td class="px-3 py-2 text-xs text-center col-expire">${expire ? escapeHtml(expire) : ''}</td>
      <td class="px-3 py-2 text-[11px] text-right col-marketmargin hidden">${marketMargin ? marketMargin.toFixed(1)+'%' : ''}</td>
      <td class="px-3 py-2 text-xs text-right col-t1">${t1 ? t1.toLocaleString() : ''}</td>
      <td class="px-3 py-2 text-[11px] text-right col-margin1">${margin1 ? margin1.toFixed(1)+'%' : ''}</td>
      <td class="px-3 py-2 text-xs text-right col-t2">${t2 ? t2.toLocaleString() : ''}</td>
      <td class="px-3 py-2 text-[11px] text-right col-margin2">${margin2 ? margin2.toFixed(1)+'%' : ''}</td>
      <td class="px-3 py-2 text-xs text-right col-t3">${t3 ? t3.toLocaleString() : ''}</td>
      <td class="px-3 py-2 text-[11px] text-right col-margin3">${margin3 ? margin3.toFixed(1)+'%' : ''}</td>
      <td class="px-3 py-2 text-xs col-actions">
        <div class="flex items-center gap-1 justify-end">
          <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px]"
                  onclick="openEditor('${(p.sku||'').replace(/'/g,"\\'")}')">
            Edit
          </button>
          ${canCurrentUserDelete() ? `
          <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-red-700 text-[11px] text-red-300"
                  onclick="deleteProduct('${(p.sku||'').replace(/'/g,"\\'")}')">
            Delete
          </button>` : ''}
        </div>
      </td>
    </tr>`;
  });
  tbody.innerHTML = html;

  const pag = $('#pagination');
  let pHtml = '';
  pHtml += `<button class="px-2 py-1 text-xs rounded-xl border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 ${currentPage===1?'opacity-40 cursor-default':''}" ${currentPage===1?'disabled':''} onclick="goPage(1)">«</button>`;
  pHtml += `<button class="px-2 py-1 text-xs rounded-xl border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 ${currentPage===1?'opacity-40 cursor-default':''}" ${currentPage===1?'disabled':''} onclick="goPage(${Math.max(1,currentPage-1)})">‹</button>`;
  for(let p=Math.max(1,currentPage-2); p<=Math.min(totalPages,currentPage+2); p++){
    pHtml += `<button class="px-2.5 py-1 text-xs rounded-xl border ${p===currentPage?'border-brand.red bg-brand.red/20 text-red-100':'border-zinc-700 bg-zinc-900 hover:bg-zinc-800'}" onclick="goPage(${p})">${p}</button>`;
  }
  pHtml += `<button class="px-2 py-1 text-xs rounded-xl border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 ${currentPage===totalPages?'opacity-40 cursor-default':''}" ${currentPage===totalPages?'disabled':''} onclick="goPage(${Math.min(totalPages,currentPage+1)})">›</button>`;
  pHtml += `<button class="px-2 py-1 text-xs rounded-xl border border-zinc-700 bg-zinc-900 hover:bg-zinc-800 ${currentPage===totalPages?'opacity-40 cursor-default':''}" ${currentPage===totalPages?'disabled':''} onclick="goPage(${totalPages})">»</button>`;
  pag.innerHTML = pHtml;
}

function goPage(p){ currentPage=p; renderTable(); }

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  })[c]);
}

/* ================= PERMISSIONS ================= */

function canCurrentUserDelete(){
  if (!currentUser) return false;
  if (currentUser.role === 'Host') return true;
  const p = currentUser.permissions || {};
  return !!p.canDeleteItem;
}


function updateColumnVisibility(){
  const ch = $('#channelSelect').value;

  // Show all columns first
  $$('.col-normal, .col-market, .col-promo, .col-expire, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3').forEach(el=>el.classList.remove('hidden'));

  if (ch === 'Flagship') {
    $$('.col-market, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3').forEach(el=>el.classList.add('hidden'));
  } else if (ch === 'Marketplace') {
    $$('.col-normal, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3').forEach(el=>el.classList.add('hidden'));
    $$('.col-marketmargin').forEach(el=>el.classList.add('hidden'));
  } else if (ch === 'Dealer') {
    $$('.col-normal, .col-market, .col-marketmargin, .col-promo, .col-expire').forEach(el=>el.classList.add('hidden'));
  }
  updatePermissionBasedUI();
}

/* ================= EDITOR ================= */

function openEditor(sku = null) {
  const isHost = currentUser.role === 'Host';
  const p = currentUser.permissions || {};
  const canPerformAction = isHost || (currentUser.role === 'Admin' && p.canAddItem);
  if (!canPerformAction) return;

  if (sku) {
    editingIndex = appData.products.findIndex(x=>x.sku===sku);
    const pd = appData.products[editingIndex];
    $('#editorTitle').textContent = 'Edit Product';
    $('#edSku').value = pd.sku; $('#edSku').disabled = true;
    $('#edDesc').value = pd.description || '';
    $('#edDetails').value = pd.details || '';
    $('#edBrand').value = pd.brand || '';
    $('#edCategory').value = pd.category || '';
    $('#edExpire').value = toDateInput(pd.expiresDate);
    $('#edNormal').value = pd.normalPrice || '';
    $('#edPromo').value = pd.promoPrice || '';
    $('#edMarket').value = pd.marketplacePrice || '';
    $('#edT1').value = pd.dealer1 || '';
    $('#edT2').value = pd.dealer2 || '';
    $('#edT3').value = pd.dealer3 || '';
  } else {
    editingIndex = -1;
    $('#editorTitle').textContent = 'Add New Product';
    ['edSku','edDesc','edDetails','edBrand','edCategory','edExpire','edNormal','edPromo','edMarket','edT1','edT2','edT3']
      .forEach(id => $(`#${id}`).value = '');
    $('#edSku').disabled = false;
  }
  applyDealerNamesToUI();
  const modalEl = $('#editorModal');
  modalEl.classList.remove('hidden');
  attachModalShortcuts(modalEl, {
    defaultButton: $('#btnSaveEd'),
    cancelButton: $('#btnCloseEditor')
  });
}

function closeEditor(){
  const modalEl = $('#editorModal');
  modalEl.classList.add('hidden');
  detachModalShortcuts(modalEl);
}

async function saveEditor() {
  const sku = $('#edSku').value.trim();
  if (!sku) { showToast('SKU is required.', 'error'); return; }
  const newProductData = {
    sku,
    description: $('#edDesc').value.trim(),
    details: $('#edDetails').value.trim(),
    brand: $('#edBrand').value.trim(),
    category: $('#edCategory').value.trim(),
    normalPrice: parseFloat($('#edNormal').value) || 0,
    promoPrice: parseFloat($('#edPromo').value) || 0,
    marketplacePrice: parseFloat($('#edMarket').value) || 0,
    dealer1: parseFloat($('#edT1').value) || 0,
    dealer2: parseFloat($('#edT2').value) || 0,
    dealer3: parseFloat($('#edT3').value) || 0,
    expiresDate: $('#edExpire').value || ''
  };
  if (editingIndex >= 0) {
    appData.products[editingIndex] = newProductData;
    log('edit_product', sku);
  } else {
    if (appData.products.some(p=>p.sku===sku)) {
      showToast('SKU already exists.', 'error');
      return;
    }
    appData.products.push(newProductData);
    log('add_product', sku);
  }
  updateLocalDataAndSave();
  closeEditor();
  showToast('Saved', 'success');
}

function toDateInput(d){
  if (!d) return '';
  if (d instanceof Date) {
    return d.toISOString().split('T')[0];
  }
  if (typeof d === 'string') {
    const dt = new Date(d);
    if (!isNaN(dt)) return dt.toISOString().split('T')[0];
  }
  return '';
}

async function deleteProduct(sku){
  const ok = await showConfirm('Delete product', `Are you sure you want to delete SKU ${sku}?`);
  if (!ok) return;
  appData.products = appData.products.filter(p=>p.sku!==sku);
  log('delete_product', sku);
  updateLocalDataAndSave();
  showToast('Deleted','success');
}

/* ================= IMPORT/EXPORT ================= */

function handleFileSelect(input, cb){
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type:'array' });
    cb(wb);
  };
  reader.readAsArrayBuffer(file);
}

function doImportMaster(input){
  handleFileSelect(input, wb=>{
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
    const products = rows.map(r=>({
      sku: String(r['SKU']||'').trim(),
      description: String(r['Description']||'').trim(),
      details: String(r['Details']||'').trim(),
      brand: String(r['Brand']||'').trim(),
      category: String(r['Category']||'').trim(),
      normalPrice: Number(r['Normal Price']||0),
      promoPrice: Number(r['Promotion Price']||0),
      expiresDate: r['Expires Date'] ? String(r['Expires Date']).slice(0,10) : '',
      marketplacePrice: Number(r['Marketplace Price']||0),
      dealer1: Number(r['Dealer T1']||0),
      dealer2: Number(r['Dealer T2']||0),
      dealer3: Number(r['Dealer T3']||0)
    })).filter(p=>p.sku);
    appData.products = products;
    log('import_master', `rows=${products.length}`);
    updateLocalDataAndSave();
    showToast(`Imported ${products.length} products`, 'success');
  });
}

function doExportMaster(){
  const rows = (appData.products||[]).map(p=>({
    'SKU': p.sku,
    'Description': p.description || '',
    'Details': p.details || '',
    'Brand': p.brand || '',
    'Category': p.category || '',
    'Normal Price': p.normalPrice || 0,
    'Promotion Price': p.promoPrice || 0,
    'Expires Date': p.expiresDate || '',
    'Marketplace Price': p.marketplacePrice || 0,
    'Dealer T1': p.dealer1 || 0,
    'Dealer T2': p.dealer2 || 0,
    'Dealer T3': p.dealer3 || 0
  }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Master');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='master.xlsx'; a.click(); URL.revokeObjectURL(a.href);
  showToast('Exported master','success');
}

function doExportPromo(){
  const rows = (appData.products||[]).filter(p=>p.promoPrice>0).map(p=>({
    'SKU': p.sku,
    'Promotion Price': p.promoPrice || 0,
    'Expires Date': p.expiresDate || ''
  }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Promotion');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='promotion.xlsx'; a.click(); URL.revokeObjectURL(a.href);
  showToast('Exported promotion','success');
}

function doImportPromo(input){
  handleFileSelect(input, wb=>{
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
    const map = new Map((appData.products||[]).map(p=>[p.sku, p]));
    let updated=0, notFound=0;
    rows.forEach(r=>{
      const sku = String(r['SKU']||'').trim();
      if (!sku) return;
      const p = map.get(sku);
      if (p){
        if (r['Promotion Price'] !== undefined && r['Promotion Price'] !== '') {
          p.promoPrice = Number(r['Promotion Price']) || 0;
        }
        if (r['Expires Date'] !== undefined && r['Expires Date'] !== '') {
          p.expiresDate = String(r['Expires Date']).slice(0,10);
        }
        updated++;
      } else notFound++;
    });
    updateLocalDataAndSave();
    showToast(`Imported promotion: updated ${updated} (missing ${notFound})`, 'success');
  });
}


function doExportVisibleByChannel(){
  const ch = $('#channelSelect').value || 'Flagship';
  const common = (p) => ({
    'SKU': p.sku,
    'Brand': p.brand || '',
    'Description': p.description || '',
    'Category': p.category || ''
  });
  let rows;
  if (ch === 'Flagship') {
    rows = filteredProducts().map(p => Object.assign(common(p), {
      'Normal Price': p.normalPrice || 0,
      'Promotion Price': p.promoPrice || 0,
      'Expires Date': p.expiresDate || ''
    }));
  } else if (ch === 'Marketplace') {
    rows = filteredProducts().map(p => Object.assign(common(p), {
      'Marketplace Price': p.marketplacePrice || 0,
      'Promotion Price': p.promoPrice || 0,
      'Expires Date': p.expiresDate || ''
    }));
  } else if (ch === 'Dealer') {
    rows = filteredProducts().map(p => Object.assign(common(p), {
      'Dealer T1': p.dealer1 || 0,
      'Dealer T2': p.dealer2 || 0,
      'Dealer T3': p.dealer3 || 0
    }));
  } else {
    rows = filteredProducts().map(p => Object.assign(common(p)));
  }

  if (!rows.length) {
    showToast('No rows to export for this channel / filter.', 'error');
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'ChannelView');
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `tags-${ch}.xlsx`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Exported current view', 'success');
}


/* ================= SETTINGS RENDER ================= */


function renderSettings(tab){
  const c = $('#settingsContent');
  if (!currentUser) return;
  const isHost = currentUser.role === 'Host';
  const p = currentUser.permissions || {};

  const allowed = (t) => {
    if (t === 'data')       return isHost || p.canManageMaster;
    if (t === 'promo')      return isHost || p.canManagePromo;
    if (t === 'templates')  return isHost || p.canManageTemplates;
    if (['logo','dealer','users','cloud','history'].includes(t)) return isHost;
    return false;
  };

  // Hide tabs user can't access
  const tabButtons = {
    data: document.querySelector('button.set-tab[data-tab="data"]'),
    promo: document.querySelector('button.set-tab[data-tab="promo"]'),
    templates: document.querySelector('button.set-tab[data-tab="templates"]'),
    logo: document.querySelector('button.set-tab[data-tab="logo"]'),
    dealer: document.querySelector('button.set-tab[data-tab="dealer"]'),
    users: document.querySelector('button.set-tab[data-tab="users"]'),
    cloud: document.querySelector('button.set-tab[data-tab="cloud"]'),
    history: document.querySelector('button.set-tab[data-tab="history"]')
  };
  Object.entries(tabButtons).forEach(([k,btn])=>{ if (btn) btn.classList.toggle('hidden', !allowed(k)); });

  if (!allowed(tab)) {
    c.innerHTML = '<div class="text-zinc-400">You do not have permission to access this page.</div>';
    return;
  }


  if (tab==='data'){
    c.innerHTML = `
      <div class="space-y-4">
        <div>
          <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
            <span class="material-icons text-sm text-brand.red">table_view</span>
            <span>Master Data</span>
          </h3>
          <p class="text-[11px] text-zinc-500 mb-2">
            Import or export the master SKU list including all channel prices.
          </p>
          <div class="flex flex-wrap items-center gap-2">
            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-[11px] cursor-pointer hover:bg-zinc-800">
              <span class="material-icons text-sm">upload</span>
              <span>Import (.xlsx)</span>
              <input type="file" id="fileImportMaster" class="hidden" accept=".xlsx,.xls">
            </label>
            <button id="btnExportMaster" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px] flex items-center gap-1.5">
              <span class="material-icons text-sm">download</span>
              <span>Export Master</span>
            </button>
          </div>
        </div>

        <div class="border-t border-zinc-800 pt-3">
          <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
            <span class="material-icons text-sm text-brand.red">sell</span>
            <span>Promotion Only</span>
          </h3>
          <p class="text-[11px] text-zinc-500 mb-2">
            Export promotion prices to share with partners or offline references.
          </p>
          <button id="btnExportPromo" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px] flex items-center gap-1.5">
            <span class="material-icons text-sm">download</span>
            <span>Export Promotion</span>
          </button>
            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-[11px] cursor-pointer hover:bg-zinc-800 ml-2">
              <span class="material-icons text-sm">upload</span>
              <span>Import Promotion (.xlsx)</span>
              <input type="file" id="fileImportPromo" class="hidden" accept=".xlsx,.xls">
            </label>
        </div>
      </div>
    `;
    $('#fileImportPromo').onchange = (e)=>doImportPromo(e.target);
    return;
  }

  if (tab==='promo'){
    c.innerHTML = `
      <div class="space-y-4">
        <div>
          <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
            <span class="material-icons text-sm text-brand.red">campaign</span>
            <span>Promotion View</span>
          </h3>
          <p class="text-[11px] text-zinc-500 mb-2">
            Use filters and date ranges in the main table to focus on promotion SKUs.
          </p>
          <ul class="text-[11px] text-zinc-400 list-disc ml-4 space-y-1">
            <li>Filter by expire date using the date picker.</li>
            <li>Use channel selector to switch between Flagship, Dealer, and Marketplace views.</li>
            <li>Export only promotion SKUs using <strong>Export Promotion</strong> in Data tab.</li>
          </ul>
        </div>
      </div>
    `;
    return;
  }

  if (tab==='templates'){
    renderTemplateSettings(c);
    return;
  }

  if (tab==='logo'){
    renderLogoSettings(c);
    return;
  }

  if (tab==='dealer'){
    renderDealerSettings(c);
    return;
  }

  if (tab==='users'){
    renderUserSettings(c);
    return;
  }

  if (tab==='history'){
    renderHistorySettings(c);
    return;
  }
}

function renderTemplateSettings(c){
  const isHost = currentUser.role === 'Host';
  c.innerHTML = `
    <div class="space-y-4">
      <div class="flex items-center justify-between gap-2">
        <div>
          <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
            <span class="material-icons text-sm text-brand.red">view_quilt</span>
            <span>Templates</span>
          </h3>
          <p class="text-[11px] text-zinc-500">
            Define how your price tags look. Drag elements on the preview to reposition them.
          </p>
        </div>
        ${isHost ? `
        <button id="btnAddTemplate" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px] flex items-center gap-1.5">
          <span class="material-icons text-sm">add</span>
          <span>New Template</span>
        </button>` : ''}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)] gap-4 items-start">
        <div class="space-y-2">
          <label class="block text-[11px] text-zinc-400 mb-1">Select Template</label>
          <select id="templateSelect" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red"></select>
          <div class="mt-2 flex flex-wrap gap-2 text-[11px]">
            <button id="btnDupTemplate" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 flex items-center gap-1.5">
              <span class="material-icons text-xs">content_copy</span>
              <span>Duplicate</span>
            </button>
            <button id="btnDelTemplate" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-red-700 text-red-300 flex items-center gap-1.5">
              <span class="material-icons text-xs">delete</span>
              <span>Delete</span>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-[11px] text-zinc-400 mb-1">Template Name</label>
          <input id="tplName" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1.2fr)_minmax(0,0.9fr)] gap-4 items-start">
        <div>
          <div class="flex items-center justify-between mb-1">
            <span class="text-[11px] text-zinc-400">Live Preview (drag to reposition)</span>
            <span class="text-[10px] text-zinc-500">Scaled down from A4 for easier editing</span>
          </div>
          <div id="tplStage" class="tpl-stage relative overflow-hidden bg-zinc-950 border border-zinc-800 rounded-xl"></div>
        </div>
        <div class="space-y-3">
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-[11px] text-zinc-400">Logo</span>
              <div class="flex gap-1">
                <button class="style-btn text-[10px]" data-style-target="mainLogo" data-style-prop="size" data-style-val="sm">Small</button>
                <button class="style-btn text-[10px]" data-style-target="mainLogo" data-style-prop="size" data-style-val="md">Medium</button>
                <button class="style-btn text-[10px]" data-style-target="mainLogo" data-style-prop="size" data-style-val="lg">Large</button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div>
                <label class="block text-[10px] text-zinc-500 mb-0.5">X</label>
                <input id="mainLogoX" type="number" class="w-full px-2 py-1 rounded bg-zinc-900 border border-zinc-700">
              </div>
              <div>
                <label class="block text-[10px] text-zinc-500 mb-0.5">Y</label>
                <input id="mainLogoY" type="number" class="w-full px-2 py-1 rounded bg-zinc-900 border border-zinc-700">
              </div>
            </div>
          </div>

          <div class="border-t border-zinc-800 pt-2">
            <div class="flex items-center justify-between mb-1">
              <span class="text-[11px] text-zinc-400">Fields</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[10px]">
              <button class="style-btn" data-style-target="brand">Brand</button>
              <button class="style-btn" data-style-target="sku">SKU</button>
              <button class="style-btn" data-style-target="description">Description</button>
              <button class="style-btn" data-style-target="price">Price</button>
              <button class="style-btn" data-style-target="promoPrice">Promotion Price</button>
              <button class="style-btn" data-style-target="expireDate">Expire Date</button>
            </div>
          </div>

          <div class="border-t border-zinc-800 pt-2">
            <label class="block text-[11px] text-zinc-400 mb-1">Font size</label>
            <input id="tplFontSize" type="number" class="w-full px-2 py-1 rounded bg-zinc-900 border border-zinc-700 text-[11px]">
          </div>
        </div>
      </div>
    </div>
  `;
  initTemplateUI();
}

function renderLogoSettings(c){
  c.innerHTML = `
    <div class="space-y-4">
      <div>
        <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
          <span class="material-icons text-sm text-brand.red">branding_watermark</span>
          <span>Main Logo</span>
        </h3>
        <p class="text-[11px] text-zinc-500 mb-2">
          Set the main logo used in the app header and as default for your tags.
        </p>
        <div class="space-y-2">
          <label class="block text-[11px] text-zinc-400 mb-1">Main Logo URL</label>
          <input id="logoUrlInput" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red">
          <p class="text-[10px] text-zinc-500">
            Paste a direct image URL (PNG recommended). Changes apply instantly across the app.
          </p>
        </div>
      </div>

      <div class="border-t border-zinc-800 pt-3">
        <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
          <span class="material-icons text-sm text-brand.red">image_search</span>
          <span>Brand Logos</span>
        </h3>
        <p class="text-[11px] text-zinc-500 mb-2">
          Configure brand-specific logos to use on tags and in the preview.
        </p>
        <div class="flex items-center gap-2 mb-2">
          <input id="brandLogoSearch" class="flex-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 text-xs focus:outline-none focus:ring-1 focus:ring-brand.red" placeholder="Filter by brand name">
          <button id="btnAddBrandLogo" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px] flex items-center gap-1.5">
            <span class="material-icons text-xs">add</span>
            <span>Add Brand</span>
          </button>
        </div>
        <div id="brandLogoList" class="space-y-2 max-h-60 overflow-auto border border-zinc-800 rounded-2xl p-2 bg-zinc-950"></div>
      </div>
    </div>
  `;
  initLogoUI();
}

function renderDealerSettings(c){
  if (!appData.dealerNames) {
    appData.dealerNames = { t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3' };
  }
  const names = appData.dealerNames;
  c.innerHTML = `
    <div class="space-y-4">
      <div>
        <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
          <span class="material-icons text-sm text-brand.red">storefront</span>
          <span>Dealer Channel Names</span>
        </h3>
        <p class="text-[11px] text-zinc-500 mb-2">
          Customize dealer tier labels used in the table and editor.
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-[11px]">
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">Dealer T1</label>
            <input id="dealerT1Name" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700" value="${escapeHtml(names.t1 || 'Dealer T1')}">
          </div>
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">Dealer T2</label>
            <input id="dealerT2Name" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700" value="${escapeHtml(names.t2 || 'Dealer T2')}">
          </div>
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">Dealer T3</label>
            <input id="dealerT3Name" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700" value="${escapeHtml(names.t3 || 'Dealer T3')}">
          </div>
        </div>
        <div class="mt-3 flex justify-end">
          <button id="btnSaveDealerNames" class="btn-primary px-4 py-2 rounded-2xl text-xs font-semibold flex items-center gap-2">
            <span class="material-icons text-sm">save</span>
            <span>Save Dealer Names</span>
          </button>
        </div>
      </div>
    </div>
  `;
  $('#btnSaveDealerNames').onclick = ()=>{
    appData.dealerNames = {
      t1: $('#dealerT1Name').value || 'Dealer T1',
      t2: $('#dealerT2Name').value || 'Dealer T2',
      t3: $('#dealerT3Name').value || 'Dealer T3'
    };
    log('update_dealerNames');
    updateLocalDataAndSave();
    applyDealerNamesToUI();
    showToast('Dealer names updated','success');
  };
  applyDealerNamesToUI();
}

function applyDealerNamesToUI(){
  if (!appData || !appData.dealerNames) return;
  const n = appData.dealerNames;
  if ($('#lblT1')) $('#lblT1').textContent = n.t1 || 'Dealer T1';
  if ($('#lblT2')) $('#lblT2').textContent = n.t2 || 'Dealer T2';
  if ($('#lblT3')) $('#lblT3').textContent = n.t3 || 'Dealer T3';
  if ($('#lblEdT1')) $('#lblEdT1').textContent = n.t1 || 'Dealer T1';
  if ($('#lblEdT2')) $('#lblEdT2').textContent = n.t2 || 'Dealer T2';
  if ($('#lblEdT3')) $('#lblEdT3').textContent = n.t3 || 'Dealer T3';
}

function renderUserSettings(c){
  const isHost = currentUser.role === 'Host';
  const users = appData.users || [];
  c.innerHTML = `
    <div class="space-y-4">
      <div class="flex items-center justify-between gap-2">
        <div>
          <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
            <span class="material-icons text-sm text-brand.red">group</span>
            <span>Users</span>
          </h3>
          <p class="text-[11px] text-zinc-500">
            Manage user accounts and channel access.
          </p>
        </div>
        ${isHost ? `
        <button id="btnAddUser" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[11px] flex items-center gap-1.5">
          <span class="material-icons text-xs">person_add</span>
          <span>New User</span>
        </button>` : ''}
      </div>

      <div class="border border-zinc-800 rounded-2xl overflow-hidden">
        <table class="w-full text-[11px]">
          <thead class="bg-zinc-900/80 border-b border-zinc-700">
            <tr>
              <th class="px-3 py-2 text-left w-28">Username</th>
              <th class="px-3 py-2 text-left w-40">Email</th>
              <th class="px-3 py-2 text-left w-20">Role</th>
              <th class="px-3 py-2 text-left">Channels</th>
              <th class="px-3 py-2 text-left w-28">Permissions</th>
              <th class="px-3 py-2 text-right w-20">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${users.map((u,idx)=>`
              <tr class="border-b border-zinc-800/80">
                <td class="px-3 py-2">${escapeHtml(u.username)}</td>
                <td class="px-3 py-2 text-zinc-400 text-[10px]">${escapeHtml(u.email || '')}</td>
                <td class="px-3 py-2">${u.role}</td>
                <td class="px-3 py-2 text-zinc-400">${(u.channels||[]).join(', ')}</td>
                <td class="px-3 py-2 text-[10px] text-zinc-400">
                  ${u.role==='Host' ? 'All' : `
                    ${u.permissions?.canAddItem ? 'Add ' : ''}
                    ${u.permissions?.canDeleteItem ? 'Delete ' : ''}
                  `}
                </td>
                <td class="px-3 py-2 text-right">
                  <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-[10px]" data-user-edit="${idx}">Edit</button>
                  ${isHost && u.role!=='Host'
                    ? `<button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-red-700 text-[10px] text-red-300" data-user-del="${idx}">Delete</button>`
                    : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div id="userEditor" class="hidden border border-zinc-800 rounded-2xl p-3 space-y-3">
        <div class="flex items-center justify-between gap-2">
          <h4 class="text-xs font-semibold">User Editor</h4>
          <button id="btnUserEditorClose" class="w-7 h-7 rounded-full border border-zinc-700 bg-black/60 hover:bg-zinc-900 grid place-items-center">
            <span class="material-icons text-zinc-400 text-sm">close</span>
          </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-[11px]">
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">Username</label>
            <input id="uUsername" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700">
          </div>
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">Email</label>
            <input id="uEmail" type="email" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700">
          </div>
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">Role</label>
            <select id="uRole" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700">
              <option>Viewer</option>
              <option>Editor</option>
              <option>Admin</option>
              <option>Host</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] text-zinc-400 mb-1">New Password (optional)</label>
            <input id="uPassword" type="password" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-[11px] text-zinc-400 mb-1">Channels</label>
            <input id="uChannels" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="Comma separated, e.g. Flagship, Dealer, Marketplace">
          </div>
          <div class="sm:col-span-2 flex items-center gap-4">
            <label class="inline-flex items-center gap-2 text-[11px]">
              <input id="uCanAddItem" type="checkbox" class="rounded bg-zinc-900 border-zinc-700">
              <span>Can add items</span>
            </label>
            <label class="inline-flex items-center gap-2 text-[11px]">
              <input id="uCanDeleteItem" type="checkbox" class="rounded bg-zinc-900 border-zinc-700">
              <span>Can delete items</span>
            </label>
          </div>
        </div>
        <div class="flex justify-end mt-2 gap-2">
          <button id="btnUserSave" class="btn-primary px-4 py-2 rounded-2xl text-xs font-semibold flex items-center gap-2">
            <span class="material-icons text-sm">save</span>
            <span>Save User</span>
          </button>
        </div>
      </div>
    </div>
  `;
  bindUserSettingsEvents();
}

function renderHistorySettings(c){
  const logs = appData.logs || [];
  c.innerHTML = `
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xs font-semibold mb-1.5 flex items-center gap-2">
            <span class="material-icons text-sm text-brand.red">history</span>
            <span>Usage History</span>
          </h3>
          <p class="text-[11px] text-zinc-500">
            Audit log of imports, edits, logins, and other operations.
          </p>
        </div>
        <span class="text-[10px] text-zinc-500">${logs.length} entries</span>
      </div>
      <div class="border border-zinc-800 rounded-2xl overflow-hidden max-h-[360px]">
        <table class="w-full text-[11px]">
          <thead class="bg-zinc-900/80 border-b border-zinc-700 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left w-40">Time</th>
              <th class="px-3 py-2 text-left w-28">User</th>
              <th class="px-3 py-2 text-left w-28">Action</th>
              <th class="px-3 py-2 text-left">Details</th>
            </tr>
          </thead>
          <tbody>
            ${logs.map(l=>`
              <tr class="border-b border-zinc-800/80">
                <td class="px-3 py-2 text-zinc-400">${new Date(l.ts).toLocaleString()}</td>
                <td class="px-3 py-2">${escapeHtml(l.user||'-')}</td>
                <td class="px-3 py-2">${escapeHtml(l.action||'')}</td>
                <td class="px-3 py-2 text-zinc-400">${escapeHtml(l.meta||'')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

/* ================= TEMPLATE UI ================= */

function initTemplateUI(){
  const sel = $('#templateSelect');
  const list = appData.templates || [];
  sel.innerHTML = '';
  list.forEach((t,idx)=>{
    const o = document.createElement('option');
    o.value = String(idx);
    o.textContent = `${t.name} (${t.kind||'A4'})`;
    sel.appendChild(o);
  });
  if (list.length>0) {
    sel.value = '0';
    currentTemplateId = list[0].id;
    loadTemplateToUI(list[0]);
  } else {
    currentTemplateId = null;
  }
  sel.onchange = ()=>{
    const idx = parseInt(sel.value,10);
    if (!isNaN(idx) && list[idx]) {
      currentTemplateId = list[idx].id;
      loadTemplateToUI(list[idx]);
    }
  };
  $('#btnAddTemplate')?.addEventListener('click', ()=>addTemplate());
  $('#btnDupTemplate')?.addEventListener('click', ()=>duplicateTemplate());
  $('#btnDelTemplate')?.addEventListener('click', ()=>deleteTemplate());
}

function loadTemplateToUI(t){
  $('#tplName').value = t.name || '';
  const stage = $('#tplStage');
  stage.innerHTML = '';
  const fields = ['sku','brand','description','price','promoPrice','expireDate'];
  fields.forEach(field=>{
    const node = document.createElement('div');
    node.className = 'tpl-node text-[10px] text-white';
    node.textContent = field.toUpperCase();
    const st = t.styles && t.styles[field] || {};
    const pos = st.position || { x:20, y:20 };
    node.style.left = (pos.x||0) + 'px';
    node.style.top = (pos.y||0) + 'px';
    stage.appendChild(node);
    makeDraggable(node, field);
  });
  const logoNode = document.createElement('div');
  logoNode.className = 'tpl-node text-[9px] text-amber-300';
  logoNode.textContent = 'LOGO';
  const l = t.logoStyles || { size:64, position:{x:20,y:20} };
  logoNode.style.left = (l.position?.x||0)+'px';
  logoNode.style.top = (l.position?.y||0)+'px';
  stage.appendChild(logoNode);
  makeDraggable(logoNode, 'mainLogo');

  $('#tplFontSize').value = t.fontSize || 12;
}

function makeDraggable(el, field) {
  const stage = $('#tplStage');
  if (!stage) return;

  let dragging = false;
  let startX = 0, startY = 0;
  let originX = 0, originY = 0;

  const onMouseDown = (e) => {
    e.preventDefault();
    e.stopPropagation();

    const stageRect = stage.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();

    dragging = true;
    el.classList.add('dragging');

    startX = e.clientX;
    startY = e.clientY;
    originX = elRect.left - stageRect.left;
    originY = elRect.top - stageRect.top;

    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
  };

  const onMouseMove = (e) => {
    if (!dragging) return;

    const stageRect = stage.getBoundingClientRect();
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    let x = originX + dx;
    let y = originY + dy;

    const maxX = stageRect.width - el.offsetWidth;
    const maxY = stageRect.height - el.offsetHeight;

    x = Math.max(0, Math.min(maxX, x));
    y = Math.max(0, Math.min(maxY, y));

    el.style.left = Math.round(x) + 'px';
    el.style.top  = Math.round(y) + 'px';
  };

  const onMouseUp = () => {
    if (!dragging) return;
    dragging = false;
    el.classList.remove('dragging');

    window.removeEventListener('mousemove', onMouseMove);
    window.removeEventListener('mouseup', onMouseUp);

    const stage = $('#tplStage');
    if (!stage || !appData) return;

    const tplSelect = $('#templateSelect');
    const idx = parseInt(tplSelect?.value ?? '-1', 10);
    if (isNaN(idx) || !appData.templates || !appData.templates[idx]) return;

    const tpl = appData.templates[idx];

    const posX = parseInt(el.style.left, 10) || 0;
    const posY = parseInt(el.style.top, 10) || 0;

    if (field === 'mainLogo') {
      tpl.logoStyles = tpl.logoStyles || { size: 64, position: { x: 0, y: 0 } };
      tpl.logoStyles.position = { x: posX, y: posY };
    } else if (field === 'brand') {
      const s = tpl.styles?.brand || {};
      tpl.styles = tpl.styles || {};
      tpl.styles.brand = { ...s, position: { x: posX, y: posY } };
    } else {
      tpl.styles = tpl.styles || {};
      const s = tpl.styles[field] || {};
      tpl.styles[field] = { ...s, position: { x: posX, y: posY } };
    }

    syncFieldControls(field, tpl);
    updateLocalDataAndSave();
  };

  el.addEventListener('mousedown', onMouseDown);
}

function syncFieldControls(field, tpl){
  if (field==='mainLogo'){
    const pos = tpl.logoStyles?.position || {x:0,y:0};
    $('#mainLogoX').value = pos.x||0;
    $('#mainLogoY').value = pos.y||0;
  }
}

function addTemplate(){
  const t = {
    id: Date.now().toString(36),
    name: 'New Template',
    kind: 'A4',
    fontSize: 12,
    styles: {},
    logoStyles: { size:64, position:{x:20,y:20} }
  };
  appData.templates = appData.templates || [];
  appData.templates.push(t);
  log('add_template', t.id);
  updateLocalDataAndSave();
  renderTemplateSettings($('#settingsContent'));
}

function duplicateTemplate(){
  const sel = $('#templateSelect');
  const idx = parseInt(sel.value,10);
  if (isNaN(idx) || !appData.templates[idx]) return;
  const src = appData.templates[idx];
  const copy = JSON.parse(JSON.stringify(src));
  copy.id = Date.now().toString(36);
  copy.name = src.name + ' Copy';
  appData.templates.push(copy);
  log('duplicate_template', src.id);
  updateLocalDataAndSave();
  renderTemplateSettings($('#settingsContent'));
}

async function deleteTemplate(){
  const sel = $('#templateSelect');
  const idx = parseInt(sel.value,10);
  if (isNaN(idx) || !appData.templates[idx]) return;
  const t = appData.templates[idx];
  const ok = await showConfirm('Delete template', `Delete template "${t.name}"?`);
  if (!ok) return;
  appData.templates.splice(idx,1);
  log('delete_template', t.id);
  updateLocalDataAndSave();
  renderTemplateSettings($('#settingsContent'));
}

/* ================= LOGO UI ================= */

function initLogoUI(){
  $('#logoUrlInput').value = appData.logoUrl || '';
  $('#logoUrlInput').onchange = ()=>{
    appData.logoUrl = $('#logoUrlInput').value.trim();
    log('update_logoUrl');
    updateLocalDataAndSave();
  };

  const list = $('#brandLogoList');
  const searchInput = $('#brandLogoSearch');

  const renderList = ()=>{
    const q = searchInput.value.trim().toLowerCase();
    const entries = Object.entries(appData.brandLogoUrls || {});
    list.innerHTML = entries
      .filter(([brand])=>!q || brand.toLowerCase().includes(q))
      .map(([brand,url])=>`
        <div class="flex items-center justify-between gap-2 border border-zinc-800 rounded-xl px-2 py-1.5 bg-zinc-950/70">
          <div class="flex-1">
            <div class="text-[11px] font-medium">${escapeHtml(brand)}</div>
            <div class="text-[10px] text-zinc-500 truncate max-w-[220px]">${escapeHtml(url)}</div>
          </div>
          <div class="flex items-center gap-1.5">
            <button class="w-7 h-7 rounded-full border border-zinc-700 bg-black/60 hover:bg-zinc-900 grid place-items-center" data-brand-edit="${brand}">
              <span class="material-icons text-zinc-400 text-sm">edit</span>
            </button>
            <button class="w-7 h-7 rounded-full border border-red-700 bg-black/60 hover:bg-red-900/40 grid place-items-center" data-brand-del="${brand}">
              <span class="material-icons text-red-300 text-sm">delete</span>
            </button>
          </div>
        </div>
      `).join('');
  };

  searchInput.oninput = ()=>renderList();
  renderList();

  $('#btnAddBrandLogo').onclick = async ()=>{
    const name = prompt('Brand name');
    if (!name) return;
    const url = prompt('Logo URL');
    if (!url) return;
    appData.brandLogoUrls = appData.brandLogoUrls || {};
    appData.brandLogoUrls[name] = url;
    log('add_brandLogo', name);
    updateLocalDataAndSave();
    renderList();
  };

  list.onclick = (e)=>{
    const btnEdit = e.target.closest('[data-brand-edit]');
    const btnDel = e.target.closest('[data-brand-del]');
    if (btnEdit){
      const brand = btnEdit.getAttribute('data-brand-edit');
      const url = prompt(`Logo URL for ${brand}`, appData.brandLogoUrls[brand] || '');
      if (!url) return;
      appData.brandLogoUrls[brand] = url;
      log('update_brandLogo', brand);
      updateLocalDataAndSave();
      renderList();
    } else if (btnDel){
      const brand = btnDel.getAttribute('data-brand-del');
      delete appData.brandLogoUrls[brand];
      log('delete_brandLogo', brand);
      updateLocalDataAndSave();
      renderList();
    }
  };
}

/* ================= USER SETTINGS EVENTS ================= */

function bindUserSettingsEvents(){
  const users = appData.users || [];
  const isHost = currentUser.role === 'Host';

  const editorBox = $('#userEditor');
  let editingUserIndex = -1;

  function openEditorBox(idx){
    editingUserIndex = idx;
    const u = idx>=0 ? users[idx] : {
      username:'',
      email:'',
      role:'Viewer',
      channels:['Flagship'],
      permissions:{ canAddItem:false, canDeleteItem:false }
    };
    $('#uUsername').value = u.username || '';
    $('#uEmail').value = u.email || '';
    $('#uRole').value = u.role || 'Viewer';
    $('#uPassword').value = '';
    $('#uChannels').value = (u.channels||[]).join(', ');
    $('#uCanAddItem').checked = !!(u.permissions && u.permissions.canAddItem);
    $('#uCanDeleteItem').checked = !!(u.permissions && u.permissions.canDeleteItem);
    editorBox.classList.remove('hidden');
  }

  $('#btnUserEditorClose').onclick = ()=>{ editorBox.classList.add('hidden'); };

  $('#btnAddUser')?.addEventListener('click', ()=>openEditorBox(-1));

  $$('#settingsContent [data-user-edit]').forEach(btn=>{
    btn.onclick = ()=>openEditorBox(parseInt(btn.getAttribute('data-user-edit'),10));
  });

  if (isHost){
    $$('#settingsContent [data-user-del]').forEach(btn=>{
      btn.onclick = async ()=>{
        const idx = parseInt(btn.getAttribute('data-user-del'),10);
        const u = users[idx];
        const ok = await showConfirm('Delete user', `Delete user "${u.username}"?`);
        if (!ok) return;
        appData.users.splice(idx,1);
        log('delete_user', u.username);
        updateLocalDataAndSave();
        renderUserSettings($('#settingsContent'));
      };
    });
  }

  $('#btnUserSave').onclick = async ()=>{
    const username = $('#uUsername').value.trim();
    const email = $('#uEmail').value.trim();
    const role = $('#uRole').value;
    const pass = $('#uPassword').value;
    const channels = $('#uChannels').value.split(',').map(s=>s.trim()).filter(Boolean);
    const canAdd = $('#uCanAddItem').checked;
    const canDel = $('#uCanDeleteItem').checked;

    if (!username) { showToast('Username is required.','error'); return; }
    if (!email) { showToast('Email is required.','error'); return; }

    if (!Array.isArray(appData.users)) appData.users = [];

    let user = editingUserIndex>=0 ? appData.users[editingUserIndex] : null;
    if (!user){
      user = { username, email:'', role:'Viewer', channels:['Flagship'], permissions:{}, passwordHash:'' };
      appData.users.push(user);
    }
    user.username = username;
    user.email = email;
    user.role = role;
    user.channels = channels.length ? channels : ['Flagship'];
    user.permissions = {
      canAddItem: canAdd,
      canDeleteItem: canDel
    };
    if (pass){
      const hash = await hashPassword(pass);
      user.passwordHash = hash;
    }

    log('update_user', username);
    updateLocalDataAndSave();
    renderUserSettings($('#settingsContent'));
    showToast('User saved','success');
  };
}

/* ================= PRINTING ================= */

function togglePrintModal(show){
  const modalEl = $('#printModal');
  modalEl.classList.toggle('hidden', !show);
  if (!show) {
    detachModalShortcuts(modalEl);
  }
}

function fillPrintTemplates(){
  const sel = $('#printTemplate'); sel.innerHTML='';
  (appData.templates||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent = `${t.name} (${t.kind||'A4'})`; sel.appendChild(o); });
}

function buildPrintList(){
  const body = $('#printBody');
  const q = $('#printSearch').value.trim().toLowerCase();
  const rows = filteredProducts().filter(p=>{
    return !q || (p.sku||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);
  });
  body.innerHTML = rows.map(p=>`
    <tr class="border-b border-zinc-800/80">
      <td class="px-2 py-1 text-center">
        <input type="checkbox" class="print-check" data-sku="${escapeHtml(p.sku)}" checked>
      </td>
      <td class="px-2 py-1 font-mono text-[11px]">${escapeHtml(p.sku)}</td>
      <td class="px-2 py-1 text-[11px]">${escapeHtml(p.description||'')}</td>
      <td class="px-1 py-1 text-center">
        <input type="number" min="1" value="1" class="print-qty w-14 px-1 py-0.5 rounded bg-zinc-900 border border-zinc-700 text-[11px]" data-sku="${escapeHtml(p.sku)}">
      </td>
    </tr>
  `).join('');
  renderPreview();
}

function getPrintSelections(){
  const checks = $$('.print-check');
  const products = [];
  checks.forEach(ch=>{
    if (!ch.checked) return;
    const sku = ch.getAttribute('data-sku');
    const qtyInput = document.querySelector(`.print-qty[data-sku="${sku}"]`);
    const qty = Math.max(1, parseInt(qtyInput?.value||'1',10));
    const p = (appData.products||[]).find(x=>x.sku===sku);
    if (p) products.push({ product:p, qty });
  });
  return products;
}

function generateSingleTagHTML(p, tpl){
  const fontSize = tpl.fontSize || 12;
  const brand = escapeHtml(p.brand||'');
  const sku = escapeHtml(p.sku||'');
  const desc = escapeHtml(p.description||'');
  const normal = p.normalPrice ? p.normalPrice.toLocaleString() : '';
  const promo = p.promoPrice ? p.promoPrice.toLocaleString() : '';
  const expire = p.expiresDate || '';

  return `
  <div style="position:relative;width:297mm;height:210mm;padding:10mm;font-family:system-ui,sans-serif;">
    <div style="position:absolute;left:${tpl.logoStyles?.position?.x||20}px;top:${tpl.logoStyles?.position?.y||20}px;font-size:${(tpl.logoStyles?.size||64)/3}px;color:#facc15;">LOGO</div>
    <div style="position:absolute;left:${tpl.styles?.brand?.position?.x||20}px;top:${tpl.styles?.brand?.position?.y||60}px;font-size:${fontSize}px;font-weight:600;">${brand}</div>
    <div style="position:absolute;left:${tpl.styles?.sku?.position?.x||20}px;top:${tpl.styles?.sku?.position?.y||90}px;font-size:${fontSize}px;">${sku}</div>
    <div style="position:absolute;left:${tpl.styles?.description?.position?.x||20}px;top:${tpl.styles?.description?.position?.y||120}px;font-size:${fontSize}px;max-width:200mm;">${desc}</div>
    <div style="position:absolute;left:${tpl.styles?.price?.position?.x||20}px;top:${tpl.styles?.price?.position?.y||150}px;font-size:${fontSize+4}px;font-weight:700;">${promo || normal}</div>
    <div style="position:absolute;left:${tpl.styles?.expireDate?.position?.x||20}px;top:${tpl.styles?.expireDate?.position?.y||180}px;font-size:${fontSize-2}px;">${expire}</div>
  </div>`;
}

function renderPreview(){
  const box = $('#previewBox');
  const selections = getPrintSelections();
  if (!selections.length){
    box.innerHTML = `<div class="text-[11px] text-zinc-500 py-8 text-center">Select SKUs on the left to preview tags.</div>`;
    return;
  }
  const tplId = $('#printTemplate').value;
  const tpl = (appData.templates||[]).find(t=>t.id===tplId) || (appData.templates||[])[0];
  if (!tpl){
    box.innerHTML = `<div class="text-[11px] text-zinc-500 py-8 text-center">No template available.</div>`;
    return;
  }
  const first = selections[0];
  const html = generateSingleTagHTML(first.product, tpl);
  box.innerHTML = `<iframe id="previewFrame" class="w-full h-[380px] bg-white rounded-xl border border-zinc-800"></iframe>`;
  const frame = $('#previewFrame');
  frame.addEventListener('load', ()=>{
    frame.contentDocument.open();
    frame.contentDocument.write(`<!DOCTYPE html><html><head><style>body{margin:0;}@page{size:A4;margin:0;}</style></head><body>${html}

<\/body><\/html>`);
    frame.contentDocument.close();
  });
  frame.src = 'about:blank';
}

function openPrintTab(){
  const selections = getPrintSelections();
  if (!selections.length){
    showToast('Select SKUs to print.','error');
    return;
  }
  const tplId = $('#printTemplate').value;
  const tpl = (appData.templates||[]).find(t=>t.id===tplId) || (appData.templates||[])[0];
  if (!tpl){
    showToast('No template selected.','error');
    return;
  }
  let pagesHTML = '';
  selections.forEach(sel=>{
    for(let i=0;i<sel.qty;i++){
      pagesHTML += generateSingleTagHTML(sel.product, tpl);
    }
  });
  const w = window.open('', '_blank');
  if (!w){
    showToast('Popup blocked. Allow popups for this site.','error');
    return;
  }
  w.document.open();
  w.document.write(`<!DOCTYPE html><html><head><title>Print Tags</title><style>
    @page { size: A4 landscape; margin: 0; }
    body { margin:0; font-family:system-ui,sans-serif; }
  </style></head><body>${pagesHTML}
<script>
// === Patch: Column visibility to match exact spec ===
(function(){
  const orig = window.updateColumnVisibility;
  window.updateColumnVisibility = function(){
    const ch = document.querySelector('#channelSelect')?.value || 'Flagship';
    // Show all
    document.querySelectorAll('.col-normal, .col-market, .col-promo, .col-expire, .col-marketmargin, .col-t1, .col-margin1, .col-t2, .col-margin2, .col-t3, .col-margin3')
      .forEach(el=>el.classList.remove('hidden'));
    if (ch === 'Flagship') {
      // Show: SKU, Brand, Description, Category, Normal, Promotion, Expire
      document.querySelectorAll('.col-market, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3')
        .forEach(el=>el.classList.add('hidden'));
    } else if (ch === 'Marketplace') {
      // Show: SKU, Brand, Description, Category, Normal, Marketplace
      document.querySelectorAll('.col-promo, .col-expire, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3, .col-marketmargin')
        .forEach(el=>el.classList.add('hidden'));
      // keep .col-normal and .col-market visible
    } else if (ch === 'Dealer') {
      // Show: SKU, Brand, Description, Category, Normal, Marketplace, T1/Margin, T2/Margin, T3/Margin
      document.querySelectorAll('.col-promo, .col-expire')
        .forEach(el=>el.classList.add('hidden'));
      // ensure everything else stays
    }
    if (typeof orig === 'function') { try { orig(); } catch(e){} }
    if (typeof window.renderTable === 'function') window.renderTable();
  };
  // Run once on load (in case UI already rendered)
  document.addEventListener('DOMContentLoaded', ()=>{ try { window.updateColumnVisibility(); } catch(e){} });
})();

// === Patch: Open Print Tab also shows Print Modal ===
(function(){
  const btn = document.querySelector('#btnOpenPrint');
  if (btn && !btn.__patchedOpenPrint) {
    btn.__patchedOpenPrint = true;
    btn.addEventListener('click', ()=>{
      // Allow original handler to run (opens new tab), then show modal
      setTimeout(()=>{
        // Try dedicated function if exists
        if (typeof window.renderPreview === 'function') window.renderPreview();
        const m = document.querySelector('#printModal');
        if (m) m.classList.remove('hidden');
      }, 50);
    });
  }
})();

// === Patch: Filter dropdown — only one at a time + Sort + Select All ===
(function(){
  // Close others before any .filter-btn opens
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.filter-btn');
    if (btn) {
      // capture phase ensured by true below
      document.querySelectorAll('.filter-dropdown').forEach(dd=>dd.classList.remove('show'));
    } else if (!e.target.closest('.filter-dropdown')) {
      document.querySelectorAll('.filter-dropdown').forEach(dd=>dd.classList.remove('show'));
    }
  }, true);

  // Enhance dropdown content after it appears
  const observer = new MutationObserver(() => {
    document.querySelectorAll('.filter-dropdown.show').forEach(dd => {
      if (dd.__enhanced) return;
      dd.__enhanced = true;
      const box = dd.querySelector('.filter-dropdown-content');
      if (!box) return;
      const toolbar = document.createElement('div');
      toolbar.className = 'flex items-center justify-between gap-2 mb-2 text-[11px]';
      toolbar.innerHTML = `
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded bg-zinc-900 border border-zinc-700" data-filter-sort="az">Sort A-Z</button>
          <button class="px-2 py-1 rounded bg-zinc-900 border border-zinc-700" data-filter-sort="za">Sort Z-A</button>
        </div>
        <div>
          <button class="px-2 py-1 rounded bg-zinc-900 border border-zinc-700" data-filter-select-all>Select All</button>
        </div>`;
      box.insertBefore(toolbar, box.firstChild);

      toolbar.addEventListener('click', (ev)=>{
        const list = dd.querySelector('[data-filter-list]');
        if (!list) return;
        if (ev.target.matches('[data-filter-sort="az"],[data-filter-sort="za"]')) {
          const items = Array.from(list.querySelectorAll('label'));
          const dir = ev.target.getAttribute('data-filter-sort');
          items.sort((a,b)=>{
            const aa = a.textContent.trim().toLowerCase();
            const bb = b.textContent.trim().toLowerCase();
            return dir === 'az' ? aa.localeCompare(bb) : bb.localeCompare(aa);
          });
          items.forEach(it=>list.appendChild(it));
        } else if (ev.target.matches('[data-filter-select-all]')) {
          list.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = true);
        }
      });
    });
  });
  observer.observe(document.body, { subtree: true, childList: true });
})();

// === Patch: Hide Settings/Edit for non-privileged user ===
(function(){
  function apply(){
    try {
      if (!window.currentUser) return;
      const role = window.currentUser.role;
      const isUser = role === 'User';
      const btn = document.querySelector('#btnSettings');
      if (btn) btn.classList.toggle('hidden', isUser);
      document.querySelectorAll('.col-actions').forEach(el => el.classList.toggle('hidden', isUser));
      const addBtn = document.querySelector('#btnNewProduct');
      if (addBtn) addBtn.classList.toggle('hidden', isUser);
    } catch(e){}
  }
  setInterval(apply, 400); // apply periodically after login/load
})();

<\/script>

<\/body><\/html>`);
  w.document.close();
  w.focus();
}

/* ================= PRINT IMPORT ================= */

function importForPrinting(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.xlsx,.xls';
  input.onchange = ()=>{
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
      const skuSet = new Set(rows.map(r=>String(r['SKU']||'').trim()).filter(Boolean));
      $('#printSearch').value = '';
      const body = $('#printBody');
      const allRows = filteredProducts();
      body.innerHTML = allRows
        .filter(p=>skuSet.has(p.sku))
        .map(p=>`
          <tr class="border-b border-zinc-800/80">
            <td class="px-2 py-1 text-center">
              <input type="checkbox" class="print-check" data-sku="${escapeHtml(p.sku)}" checked>
            </td>
            <td class="px-2 py-1 font-mono text-[11px]">${escapeHtml(p.sku)}</td>
            <td class="px-2 py-1 text-[11px]">${escapeHtml(p.description||'')}</td>
            <td class="px-1 py-1 text-center">
              <input type="number" min="1" value="1" class="print-qty w-14 px-1 py-0.5 rounded bg-zinc-900 border border-zinc-700 text-[11px]" data-sku="${escapeHtml(p.sku)}">
            </td>
          </tr>
        `).join('');
      renderPreview();
      showToast(`Imported ${skuSet.size} SKUs for printing.`, 'success');
    };
    reader.readAsArrayBuffer(file);
  };
  input.click();
}

/* ================= AUTH & VIEWS ================= */

function performLogin(user) {
  currentUser = user;
  localStorage.setItem(LS.LAST_USER, user.username);
  columnFilters = {};
  $('#setupView').classList.add('hidden');
  $('#loginView').classList.add('hidden');
  $('#resetView').classList.add('hidden');
  $('#appView').classList.remove('hidden');
  $('#roleBadge').textContent = `${currentUser.role} • ${currentUser.username}`;
  initFiltersForUser();
  bindAppEvents();
  updatePermissionBasedUI();
  log('login');
  updateLocalDataAndSave();
}

async function login(){
  const u = $('#loginUser').value.trim();
  const p = $('#loginPass').value;
  $('#loginError').classList.add('hidden');
  $('#loginLoading').classList.remove('hidden');
  try {
    if (!appData || !appData.users || appData.users.length === 0) {
      $('#loginError').textContent = 'No users available. Please set up system first.';
      $('#loginError').classList.remove('hidden');
      return;
    }
    const hash = await hashPassword(p);
    const user = appData.users.find(x => (x.username === u || x.email === u) && x.passwordHash === hash);
    if (!user) {
      $('#loginError').textContent = 'Invalid username/email or password.';
      $('#loginError').classList.remove('hidden');
      return;
    }
    performLogin(user);
  } catch (e) {
    console.error(e);
    $('#loginError').textContent = 'Login failed. Please try again.';
    $('#loginError').classList.remove('hidden');
  } finally {
    $('#loginLoading').classList.add('hidden');
  }
}

async function handleSetup(){
  const username = $('#setupUser').value.trim();
  const email = $('#setupEmail').value.trim();
  const pw = $('#setupPass').value;
  const pw2 = $('#setupPassConfirm').value;
  if (!username || !email || !pw || !pw2) {
    showToast('Please fill all fields.','error'); return;
  }
  if (pw !== pw2) {
    showToast('Passwords do not match.','error'); return;
  }
  if (!appData) appData = {};
  appData.users = appData.users || [];
  if (appData.users.some(u=>u.role==='Host')){
    showToast('Host already exists.','error'); return;
  }
  const hash = await hashPassword(pw);
  appData.users.push({
    username,
    email,
    role:'Host',
    channels:['Flagship','Dealer','Marketplace'],
    permissions:{ canAddItem:true, canDeleteItem:true },
    passwordHash:hash
  });
  appData.products = appData.products || [];
  appData.templates = appData.templates || [];
  appData.dealerNames = appData.dealerNames || { t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3' };
  appData.brandLogoUrls = appData.brandLogoUrls || {};
  appData.logs = appData.logs || [];
  log('setup_host', username);
  await apiSave();
  showToast('Host created. Please sign in.','success');
  $('#setupView').classList.add('hidden');
  $('#loginView').classList.remove('hidden');
}

function logout(){
  log('logout');
  updateLocalDataAndSave();
  currentUser = null;
  $('#appView').classList.add('hidden');
  $('#setupView').classList.add('hidden');
  $('#resetView').classList.add('hidden');
  $('#loginView').classList.remove('hidden');
}


function updatePermissionBasedUI(){
  if (!currentUser) return;
  const isHost = currentUser.role === 'Host';
  const isAdmin = currentUser.role === 'Admin';
  const p = currentUser.permissions || {};
  const canAddItem = isHost || (isAdmin && p.canAddItem);
  const canSeeActions = canAddItem;
  
  $$('.col-actions').forEach(el => el.classList.toggle('hidden', !canSeeActions));
  
  const btnNew = $('#btnNewProduct');
  if (btnNew) {
    btnNew.classList.toggle('hidden', !canAddItem);
  }
  
  const btnSettings = $('#btnSettings');
  if (btnSettings) {
    btnSettings.classList.toggle('hidden', (!isHost && !isAdmin));
  }
}

function initFiltersForUser(){
  const sel=$('#channelSelect');
  const currentChannel = sel.value;
  sel.innerHTML='';
  (currentUser.channels || []).forEach(ch=>{ 
    const o=document.createElement('option'); 
    o.textContent=ch; 
    o.value = ch; 
    sel.appendChild(o); 
  });
  sel.value = currentChannel && currentUser.channels.includes(currentChannel) ? currentChannel : (currentUser.channels[0] || '');
  updateColumnVisibility();
}

/* ================= RESET PASSWORD FLOW ================= */

function bindResetEvents(){
  $('#btnGotoForgot').onclick = ()=>{
    $('#loginView').classList.add('hidden');
    $('#resetView').classList.remove('hidden');
    $('#resetStep1').classList.remove('hidden');
    $('#resetStep2').classList.add('hidden');
    $('#resetMsg').textContent = '';
    $('#resetEmail').value = '';
    $('#resetOtp').value = '';
    $('#resetNewPass').value = '';
  };

  $('#btnBackToLogin1').onclick = ()=>{
    $('#resetView').classList.add('hidden');
    $('#loginView').classList.remove('hidden');
  };
  $('#btnBackToLogin2').onclick = ()=>{
    $('#resetView').classList.add('hidden');
    $('#loginView').classList.remove('hidden');
  };

  $('#btnRequestOtp').onclick = async ()=>{
    const email = $('#resetEmail').value.trim();
    if (!email) { showToast('Enter your email.','error'); return; }
    try {
      $('#resetMsg').textContent = 'Requesting OTP...';
      const res = await apiOtp('request', email);
      $('#resetMsg').textContent = 'OTP sent to your email. Please check your inbox.';
      $('#resetStep1').classList.add('hidden');
      $('#resetStep2').classList.remove('hidden');
    } catch (e) {
      showToast(e.message || 'Failed to request OTP','error');
      $('#resetMsg').textContent = e.message || 'Failed to request OTP';
    }
  };

  $('#btnConfirmReset').onclick = async ()=>{
    const email = $('#resetEmail').value.trim();
    const otp = $('#resetOtp').value.trim();
    const newPass = $('#resetNewPass').value;
    if (!email || !otp || !newPass) {
      showToast('Fill all fields.','error'); return;
    }
    try {
      $('#resetMsg').textContent = 'Changing password...';
      const hash = await hashPassword(newPass);
      await apiOtp('reset', email, otp, hash);
      await forceReloadAppData();
      $('#resetMsg').textContent = 'Password changed successfully. You can log in with the new password.';
      showToast('Password changed.','success');
    } catch (e) {
      showToast(e.message || 'Failed to reset password','error');
      $('#resetMsg').textContent = e.message || 'Failed to reset password';
    }
  };
}

/* ================= BIND APP EVENTS ================= */

function bindAppEvents() {
  $('#btnLogout').onclick = logout;
  $('#btnNewProduct').onclick = () => openEditor();
  $('#btnSettings').onclick = () => { const tab = defaultSettingsTabFor(currentUser); if (tab) openSettings(tab); };
  $('#btnPrintModal').onclick = () => {
    fillPrintTemplates();
    buildPrintList();
    togglePrintModal(true);
    
  const hdrCheck = $('#printCheckAll');
  if (hdrCheck) {
    hdrCheck.onchange = () => {
      const checked = hdrCheck.checked;
      $$('#printBody .print-check').forEach(ch => { ch.checked = checked; });
      renderPreview();
    };
  }
const modalEl = $('#printModal');
    attachModalShortcuts(modalEl, {
      defaultButton: $('#btnOpenPrint'),
      cancelButton: $('#btnClosePrintModal')
    });
  };

  $('#searchInput').oninput = debounce(() => { currentPage = 1; renderTable(); }, 300);
  $('#channelSelect').onchange = () => { currentPage = 1; renderTable(); };

  $('#btnCloseSettings').onclick = () => $('#settingsPanel').classList.add('hidden');

  $$('.set-tab').forEach(b => b.onclick = () => openSettings(b.dataset.tab));
  $('#btnCloseEditor').onclick = closeEditor;
  $('#btnSaveEd').onclick = saveEditor;

  $('#btnClosePrintModal').onclick = () => togglePrintModal(false);
  $('#btnOpenPrint').onclick = openPrintTab;
  $('#printSearch').oninput = debounce(() => buildPrintList(), 200);
  $('#btnPrintImport').onclick = importForPrinting;

  const btnExportChannel = $('#btnExportChannel');
  if (btnExportChannel) {
    btnExportChannel.onclick = doExportVisibleByChannel;
  }

  window.addEventListener('scroll', closeAllFilterDropdowns, { passive:true });
  window.addEventListener('resize', closeAllFilterDropdowns);
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-btn')) closeAllFilterDropdowns(); });
}

function defaultSettingsTabFor(user){
  if (!user) return 'data';
  if (user.role === 'Host' || user.role === 'Admin') return 'data';
  return 'logo';
}

function openSettings(tab){
  $('#settingsPanel').classList.remove('hidden');
  $$('.set-tab').forEach(b=>{
    if (b.dataset.tab===tab) b.classList.add('tab-pill-active','border-zinc-700');
    else b.classList.remove('tab-pill-active','border-zinc-700');
  });
  renderSettings(tab);
}

/* ================= AUTH BINDINGS ================= */

function bindAuthEvents(){
  $('#btnLogin').onclick = ()=>login();
  $('#loginPass').addEventListener('keypress', (e)=>{ if(e.key==='Enter') login(); });
  $('#btnSetup').onclick = ()=>handleSetup();
  bindResetEvents();
}

/* ================= INIT ================= */
async function init() {
  bindAuthEvents();

    // DatePicker + Clear (same behavior as old index)
  const datePickerElement = $('#dateRangePicker');
  if (datePickerElement) {
    const picker = new Litepicker({ 
      element: datePickerElement,
      singleMode: false,
      format: 'DD MMM YYYY',
      tooltipText: {
        one: 'day',
        other: 'days'
      },
      resetButton: true,
      buttonText: {
        previousMonth: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`,
        nextMonth: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>`,
        reset: 'Clear'
      },
      setup: (picker) => {
        picker.on('selected', (date1, date2) => {
          $('#dateStart').value = date1 ? date1.format('YYYY-MM-DD') : '';
          $('#dateEnd').value = date2 ? date2.format('YYYY-MM-DD') : '';
          currentPage = 1;
          renderTable();
        });
        picker.on('clear:selection', () => {
          $('#dateStart').value = '';
          $('#dateEnd').value = '';
          currentPage = 1;
          renderTable();
        });
      }
    });

    // External clear button
    const btnClear = $('#btnDateClear');
    if (btnClear) {
      btnClear.onclick = () => {
        if (picker.clearSelection) picker.clearSelection();
        $('#dateRangePicker').value = '';
        $('#dateStart').value = '';
        $('#dateEnd').value = '';
        currentPage = 1;
        renderTable();
      };
    }
  }

  try {
    await apiLoad();
    if (!appData || !appData.users || appData.users.length === 0) {
      $('#setupView').classList.remove('hidden');
    } else {
      $('#loginView').classList.remove('hidden');
      const last = localStorage.getItem(LS.LAST_USER);
      if (last) $('#loginUser').value = last;
    }
  } catch (e) {
    showToast('Failed to load initial data.', 'error');
  }

  renderTableHeader();
  renderTable();
}

init();

// === Patch: Column visibility to match exact spec ===
(function(){
  const orig = window.updateColumnVisibility;
  window.updateColumnVisibility = function(){
    const ch = document.querySelector('#channelSelect')?.value || 'Flagship';
    // Show all
    document.querySelectorAll('.col-normal, .col-market, .col-promo, .col-expire, .col-marketmargin, .col-t1, .col-margin1, .col-t2, .col-margin2, .col-t3, .col-margin3')
      .forEach(el=>el.classList.remove('hidden'));
    if (ch === 'Flagship') {
      // Show: SKU, Brand, Description, Category, Normal, Promotion, Expire
      document.querySelectorAll('.col-market, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3')
        .forEach(el=>el.classList.add('hidden'));
    } else if (ch === 'Marketplace') {
      // Show: SKU, Brand, Description, Category, Normal, Marketplace
      document.querySelectorAll('.col-promo, .col-expire, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3, .col-marketmargin')
        .forEach(el=>el.classList.add('hidden'));
      // keep .col-normal and .col-market visible
    } else if (ch === 'Dealer') {
      // Show: SKU, Brand, Description, Category, Normal, Marketplace, T1/Margin, T2/Margin, T3/Margin
      document.querySelectorAll('.col-promo, .col-expire')
        .forEach(el=>el.classList.add('hidden'));
      // ensure everything else stays
    }
    if (typeof orig === 'function') { try { orig(); } catch(e){} }
    if (typeof window.renderTable === 'function') window.renderTable();
  };
  // Run once on load (in case UI already rendered)
  document.addEventListener('DOMContentLoaded', ()=>{ try { window.updateColumnVisibility(); } catch(e){} });
})();

// === Patch: Open Print Tab also shows Print Modal ===
(function(){
  const btn = document.querySelector('#btnOpenPrint');
  if (btn && !btn.__patchedOpenPrint) {
    btn.__patchedOpenPrint = true;
    btn.addEventListener('click', ()=>{
      // Allow original handler to run (opens new tab), then show modal
      setTimeout(()=>{
        // Try dedicated function if exists
        if (typeof window.renderPreview === 'function') window.renderPreview();
        const m = document.querySelector('#printModal');
        if (m) m.classList.remove('hidden');
      }, 50);
    });
  }
})();

// === Patch: Filter dropdown — only one at a time + Sort + Select All ===
(function(){
  // Close others before any .filter-btn opens
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.filter-btn');
    if (btn) {
      // capture phase ensured by true below
      document.querySelectorAll('.filter-dropdown').forEach(dd=>dd.classList.remove('show'));
    } else if (!e.target.closest('.filter-dropdown')) {
      document.querySelectorAll('.filter-dropdown').forEach(dd=>dd.classList.remove('show'));
    }
  }, true);

  // Enhance dropdown content after it appears
  const observer = new MutationObserver(() => {
    document.querySelectorAll('.filter-dropdown.show').forEach(dd => {
      if (dd.__enhanced) return;
      dd.__enhanced = true;
      const box = dd.querySelector('.filter-dropdown-content');
      if (!box) return;
      const toolbar = document.createElement('div');
      toolbar.className = 'flex items-center justify-between gap-2 mb-2 text-[11px]';
      toolbar.innerHTML = `
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded bg-zinc-900 border border-zinc-700" data-filter-sort="az">Sort A-Z</button>
          <button class="px-2 py-1 rounded bg-zinc-900 border border-zinc-700" data-filter-sort="za">Sort Z-A</button>
        </div>
        <div>
          <button class="px-2 py-1 rounded bg-zinc-900 border border-zinc-700" data-filter-select-all>Select All</button>
        </div>`;
      box.insertBefore(toolbar, box.firstChild);

      toolbar.addEventListener('click', (ev)=>{
        const list = dd.querySelector('[data-filter-list]');
        if (!list) return;
        if (ev.target.matches('[data-filter-sort="az"],[data-filter-sort="za"]')) {
          const items = Array.from(list.querySelectorAll('label'));
          const dir = ev.target.getAttribute('data-filter-sort');
          items.sort((a,b)=>{
            const aa = a.textContent.trim().toLowerCase();
            const bb = b.textContent.trim().toLowerCase();
            return dir === 'az' ? aa.localeCompare(bb) : bb.localeCompare(aa);
          });
          items.forEach(it=>list.appendChild(it));
        } else if (ev.target.matches('[data-filter-select-all]')) {
          list.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = true);
        }
      });
    });
  });
  observer.observe(document.body, { subtree: true, childList: true });
})();

// === Patch: Hide Settings/Edit for non-privileged user ===
(function(){
  function apply(){
    try {
      if (!window.currentUser) return;
      const role = window.currentUser.role;
      const isUser = role === 'User';
      const btn = document.querySelector('#btnSettings');
      if (btn) btn.classList.toggle('hidden', isUser);
      document.querySelectorAll('.col-actions').forEach(el => el.classList.toggle('hidden', isUser));
      const addBtn = document.querySelector('#btnNewProduct');
      if (addBtn) addBtn.classList.toggle('hidden', isUser);
    } catch(e){}
  }
  setInterval(apply, 400); // apply periodically after login/load
})();

</script>


<!-- === SAFE OVERRIDES BLOCK (appended) === -->
<script>
(function(){
  // 1) Column visibility per-channel (exact spec)
  const _orig_updateColumnVisibility = window.updateColumnVisibility;
  window.updateColumnVisibility = function(){
    try {
      const ch = $('#channelSelect').value;
      // Show all by default
      $$('.col-normal, .col-market, .col-promo, .col-expire, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3')
        .forEach(el=>el.classList.remove('hidden'));

      if (ch === 'Flagship') {
        // Show: SKU, Brand, Description, Category, Normal Price, Promotion, Expire Date
        $$('.col-market, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3')
          .forEach(el=>el.classList.add('hidden'));
      } else if (ch === 'Dealer') {
        // Show: SKU, Brand, Description, Category, Normal Price, Marketplace Price,
        // Dealer T1 + Margin, Dealer T2 + Margin, Dealer T3 + Margin
        // Hide: Promotion, Expire
        $$('.col-promo, .col-expire')
          .forEach(el=>el.classList.add('hidden'));
        $$('.col-normal, .col-market, .col-marketmargin, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3')
          .forEach(el=>el.classList.remove('hidden'));
      } else if (ch === 'Marketplace') {
        // Show: SKU, Brand, Description, Category, Normal Price, Marketplace Price
        // Hide: Promotion, Expire, Dealer columns, Dealer margins, Market margin
        $$('.col-promo, .col-expire, .col-t1, .col-t2, .col-t3, .col-margin1, .col-margin2, .col-margin3, .col-marketmargin')
          .forEach(el=>el.classList.add('hidden'));
        $$('.col-normal, .col-market').forEach(el=>el.classList.remove('hidden'));
      }
      updatePermissionBasedUI();
    } catch(e){
      console.error('updateColumnVisibility override error', e);
      if (typeof _orig_updateColumnVisibility === 'function') _orig_updateColumnVisibility();
    }
  };

  // 2) Close other filter dropdowns before opening a new one
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.filter-btn');
    if (btn){
      try { closeAllFilterDropdowns(); } catch(_) {}
    }
  }, true); // capture

  // 3) Enhance filter dropdown with Select All + Sort A–Z/Z–A
  const _orig_buildFilterDropdown = window.buildFilterDropdown;
  window.buildFilterDropdown = function(key, anchor){
    const dd = $(`#filter-dropdown-${key}`);

    const filterKeyMap = {
      normal: 'normalPrice',
      promo: 'promoPrice',
      expire: 'expiresDate',
      market: 'marketplacePrice',
      t1: 'dealer1',
      t2: 'dealer2',
      t3: 'dealer3'
    };
    const prop = filterKeyMap[key] || key;

    const values = new Set(
      (appData.products || [])
        .map(p => String(p[prop] ?? ''))
        .filter(v => v !== '')
    );

    dd.innerHTML = `
      <div class="filter-dropdown-content">
        <div class="flex items-center gap-2 mb-1">
          <input type="text" class="w-full px-2 py-1 rounded bg-zinc-900 border border-zinc-700 text-xs" placeholder="Search value..." data-filter-search="${key}" />
        </div>
        <div class="flex items-center gap-2 mb-1 text-xs">
          <button class="px-2 py-1 rounded bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-filter-selectall="${key}">Select All</button>
          <button class="px-2 py-1 rounded bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-filter-sortasc="${key}">Sort A–Z</button>
          <button class="px-2 py-1 rounded bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-filter-sortdesc="${key}">Sort Z–A</button>
        </div>
        <div class="max-h-52 overflow-auto text-xs space-y-1" data-filter-list="${key}">
          ${Array.from(values).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'})).map(v=>{
            const checked = columnFilters[key] && columnFilters[key].has(v);
            return `<label class="flex items-center gap-2">
              <input type="checkbox" value="${v.replace(/"/g,'&quot;')}" ${checked?'checked':''} class="filter-chk" data-filter-key="${key}" />
              <span>${v||'<em>(empty)</em>'}</span>
            </label>`;
          }).join('')}
        </div>
        <div class="flex justify-between mt-2 text-xs">
          <button class="px-2 py-1 rounded bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-filter-clear="${key}">Clear</button>
          <button class="px-2 py-1 rounded bg-brand.red hover:bg-red-600 border border-red-700" data-filter-apply="${key}">Apply</button>
        </div>
      </div>`;

    const rect = anchor.getBoundingClientRect();
    dd.style.left = rect.left + 'px';
    dd.style.top  = (rect.bottom + 4) + 'px';
    dd.classList.add('show');
  };

  // Document-level handler for new filter controls
  document.addEventListener('click', (e)=>{
    const selAllBtn = e.target.closest('[data-filter-selectall]');
    const sortAscBtn = e.target.closest('[data-filter-sortasc]');
    const sortDescBtn = e.target.closest('[data-filter-sortdesc]');
    if (selAllBtn){
      const box = selAllBtn.closest('.filter-dropdown');
      if (box) box.querySelectorAll('.filter-chk').forEach(ch => ch.checked = true);
    } else if (sortAscBtn || sortDescBtn){
      const key = (sortAscBtn ? sortAscBtn : sortDescBtn).getAttribute(sortAscBtn ? 'data-filter-sortasc' : 'data-filter-sortdesc');
      const map = { normal:'normal', market:'market', promo:'promo', expire:'expire', t1:'t1', t2:'t2', t3:'t3' };
      sortState.key = map[key] || key;
      sortState.direction = sortAscBtn ? 'asc' : 'desc';
      renderTableHeader(); renderTable();
    }
  });

  // Close dropdowns on outside click
  window.addEventListener('click', (e)=>{
    if (!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-btn')){
      try { closeAllFilterDropdowns(); } catch(_) {}
    }
  });

  // 4) Settings: Data/Promo old-style but keep current IDs & functions
  const _orig_renderSettings = window.renderSettings;
  window.renderSettings = function(tab){
    const c = $('#settingsContent');
    if (!currentUser) return;
    const isHost = currentUser.role === 'Host';
    const p = currentUser.permissions || {};

    const allowed = (t) => {
      if (t === 'data')       return isHost || p.canManageMaster;
      if (t === 'promo')      return isHost || p.canManagePromo;
      if (t === 'templates')  return isHost || p.canManageTemplates;
      if (['logo','dealer','users','history'].includes(t)) return isHost;
      return false;
    };

    // Hide tabs not allowed
    const tabButtons = {
      data: document.querySelector('button.set-tab[data-tab="data"]'),
      promo: document.querySelector('button.set-tab[data-tab="promo"]'),
      templates: document.querySelector('button.set-tab[data-tab="templates"]'),
      logo: document.querySelector('button.set-tab[data-tab="logo"]'),
      dealer: document.querySelector('button.set-tab[data-tab="dealer"]'),
      users: document.querySelector('button.set-tab[data-tab="users"]'),
      history: document.querySelector('button.set-tab[data-tab="history"]')
    };
    Object.entries(tabButtons).forEach(([k,btn])=>{ if (btn) btn.classList.toggle('hidden', !allowed(k)); });

    if (!allowed(tab)){
      // fallback to any accessible tab
      const order = ['data','promo','templates','logo','dealer','users','history'];
      const fb = order.find(k=>allowed(k));
      c.innerHTML = fb ? '' : '<div class="text-zinc-400">You do not have permission to access this page.</div>';
      if (fb){ window.renderSettings(fb); }
      return;
    }

    if (tab === 'data'){
      c.innerHTML = `
        <div class="text-2xl font-semibold mb-2">Manage Master Data</div>
        <div class="text-zinc-400 mb-4">Import or Export the main product data.</div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
            <div class="font-semibold mb-2">Import Master File (.xlsx)</div>
            <input id="fileImportMaster" type="file" accept=".xlsx,.xls" class="w-full">
            <p class="text-xs text-zinc-400 mt-2">Columns: SKU, Brand, Description, Details, Category, Normal, Marketplace, Dealer T1, Dealer T2, Dealer T3</p>
            <button id="btnDoImportMaster" class="mt-4 px-4 py-2 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">
              Import Master
            </button>
          </div>
          <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
            <div class="font-semibold mb-2">Export Master File (.xlsx)</div>
            <button id="btnExportMaster" class="px-4 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">
              Export Master
            </button>
          </div>
        </div>
      `;
      const inp = $('#fileImportMaster');
      if (inp) inp.onchange = (e)=>doImportMaster(e.target);
      const btnE = $('#btnExportMaster');
      if (btnE) btnE.onclick = ()=>doExportMaster();
      return;
    }

    if (tab === 'promo'){
      c.innerHTML = `
        <div class="text-2xl font-semibold mb-2">Manage Promotion Data</div>
        <div class="text-zinc-400 mb-4">Import/Export promotion-only dataset.</div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
            <div class="font-semibold mb-2">Import Promotion File (.xlsx)</div>
            <input id="fileImportPromo" type="file" accept=".xlsx,.xls" class="w-full">
            <p class="text-xs text-zinc-400 mt-2">Columns: SKU, Description, Normal, Promotion, Expires</p>
            <button id="btnDoImportPromo" class="mt-4 px-4 py-2 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">
              Import Promotion
            </button>
          </div>
          <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
            <div>
              <div class="font-semibold mb-2">Export Promotion File (.xlsx)</div>
              <button id="btnExportPromo" class="px-4 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">
                Export Promotion
              </button>
            </div>
          </div>
        </div>
      `;
      const inp = $('#fileImportPromo');
      if (inp) inp.onchange = (e)=>doImportPromo(e.target);
      const btnE = $('#btnExportPromo');
      if (btnE) btnE.onclick = ()=>doExportPromo();
      return;
    }

    if (tab === 'templates'){ return renderTemplateSettings(c); }
    if (tab === 'logo'){ return renderLogoSettings(c); }
    if (tab === 'dealer'){ return renderDealerSettings(c); }
    if (tab === 'users'){ return renderUserSettings(c); }
    if (tab === 'history'){ return renderHistorySettings(c); }

    if (typeof _orig_renderSettings === 'function') return _orig_renderSettings(tab);
  };

  // 5) Keep Print Modal open after opening print tab
  const _orig_openPrintTab = window.openPrintTab;
  window.openPrintTab = function(){
    try {
      if (typeof _orig_openPrintTab === 'function') _orig_openPrintTab();
    } finally {
      try { togglePrintModal(true); } catch(_) {}
    }
  };

  // 6) Hide Settings & edit controls for plain User
  const _orig_updatePermissionBasedUI2 = window.updatePermissionBasedUI;
  window.updatePermissionBasedUI = function(){
    try {
      if (!currentUser) return;
      const isHost = currentUser.role === 'Host';
      const isAdmin = currentUser.role === 'Admin';
      const p = currentUser.permissions || {};
      const canAddItem = isHost || (isAdmin && p.canAddItem);
      const canSeeActions = canAddItem;
      $$('.col-actions').forEach(el => el.classList.toggle('hidden', !canSeeActions));
      const btnNew = $('#btnNewProduct'); if (btnNew) btnNew.classList.toggle('hidden', !canAddItem);
      const btnSettings = $('#btnSettings'); if (btnSettings) btnSettings.classList.toggle('hidden', (!isHost && !isAdmin));
    } catch(e){
      console.error('updatePermissionBasedUI override error', e);
    }
  };

  // 7) Case-insensitive brand helpers (available for Logo page if needed)
  window._brandKeyCanon = (name)=> String(name||'').trim().toLowerCase();
  window.getAllBrandsCI = ()=>{
    const set = new Map();
    (appData.products||[]).forEach(p=>{
      const b = String(p.brand||'').trim();
      if (!b) return;
      const k = _brandKeyCanon(b);
      if (!set.has(k)) set.set(k, b); // preserve first seen original case
    });
    Object.keys(appData.brandLogoUrls||{}).forEach(k=>{
      const kk = _brandKeyCanon(k);
      if (!set.has(kk)) set.set(kk, k);
    });
    return Array.from(set.values()).sort((a,b)=>a.localeCompare(b));
  };

  console.log('[Overrides] Loaded safely.');
})();
</script>

</body>
</html>
